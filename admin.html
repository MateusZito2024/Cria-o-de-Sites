<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asthro | Admin</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://i.imgur.com/ZeaGXHD.png">

  <style>
    :root{
      --bg0:#070712;
      --bg1:#0b0b18;
      --card: rgba(255,255,255,.04);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --txt:#edf1f7;
      --muted: rgba(237,241,247,.70);
      --cyan:#0bf4ed;
      --purple:#6627ff;
      --pink:#ff2766;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    html, body { height: 100%; }
    body{
      margin:0;
      color: var(--txt);
      background:
        radial-gradient(1100px 800px at 20% 10%, rgba(102,39,255,.20), transparent 50%),
        radial-gradient(900px 700px at 85% 15%, rgba(11,244,237,.14), transparent 55%),
        radial-gradient(900px 900px at 60% 90%, rgba(255,39,102,.08), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      background-size: 400% 400%;
      animation: bgMove 18s ease-in-out infinite;
      overflow-x:hidden;
      font-family: 'Manrope', sans-serif;
    }
    @keyframes bgMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    h1,h2,h3,h4{ font-family:'Archivo', sans-serif; }

    .stars-container{
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events:none;
    }
    .star{
      position:absolute;
      width:2px;height:2px;border-radius:50%;
      opacity:.35;
      box-shadow:0 0 10px rgba(255,255,255,.25);
      animation: floatStar 16s ease-in-out infinite;
    }
    .star.purple{ background: var(--purple); box-shadow:0 0 10px rgba(102,39,255,.35); }
    .star.cyan{ background: var(--cyan); box-shadow:0 0 10px rgba(11,244,237,.30); }
    .star.white{ background: #fff; box-shadow:0 0 10px rgba(255,255,255,.25); }
    @keyframes floatStar{
      0%{ transform: translate(0,0); opacity:.25 }
      50%{ transform: translate(var(--mx), var(--my)); opacity:.6 }
      100%{ transform: translate(0,0); opacity:.25 }
    }

    .content-layer{ position: relative; z-index: 2; }

    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .glass-strong{
      background: var(--card2);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .gradient-text{
      background: linear-gradient(135deg, var(--purple), var(--cyan));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .field{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      color: var(--txt);
      outline:none;
    }
    .field:focus{
      border-color: rgba(11,244,237,.45);
      box-shadow: 0 0 0 3px rgba(11,244,237,.12);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      border: 1px solid rgba(255,255,255,.10);
      transition: transform .15s ease, background .2s ease, border .2s ease, box-shadow .2s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn-primary{
      background: linear-gradient(135deg, rgba(102,39,255,.95), rgba(11,244,237,.65));
      color:#071016;
      border-color: rgba(11,244,237,.25);
      box-shadow: 0 10px 30px rgba(102,39,255,.15);
    }
    .btn-ghost{
      background: rgba(255,255,255,.06);
      color: var(--txt);
    }
    .btn-ghost:hover{ background: rgba(255,255,255,.10); }

    .tab{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      transition: background .2s ease, border .2s ease, transform .15s ease;
      font-weight: 900;
      color: var(--txt);
    }
    .tab:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }
    .tab.active{
      background: linear-gradient(135deg, rgba(102,39,255,.28), rgba(11,244,237,.12));
      border-color: rgba(102,39,255,.45);
    }

    .custom-dialog{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      z-index: 50;
      padding: 16px;
    }
  </style>
</head>

<body>
  <div class="stars-container" id="stars-container"></div>

  <!-- CONFIRM DIALOG -->
  <div id="confirm-dialog" class="custom-dialog hidden">
    <div class="glass-strong content-layer w-full max-w-md rounded-2xl p-6">
      <h4 class="text-xl font-bold gradient-text">Confirma√ß√£o</h4>
      <p id="confirm-message" class="mt-3 text-sm" style="color: var(--muted); font-weight:700;"></p>
      <div class="mt-6 flex justify-end gap-3">
        <button id="confirm-cancel" class="btn btn-ghost">Cancelar</button>
        <button id="confirm-ok" class="btn btn-primary">Finalizar</button>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <section id="login-section" class="content-layer min-h-screen flex items-center justify-center p-6">
    <div class="glass-strong w-full max-w-md rounded-3xl p-6 md:p-8">
      <div class="flex items-center gap-3 mb-6">
        <img src="https://i.imgur.com/sE44ypp.png" alt="Asthro" class="h-10 w-auto">
        <div class="leading-tight">
          <div class="text-lg font-extrabold gradient-text" style="font-family:'Archivo',sans-serif;">Asthro Admin</div>
          <div class="text-xs" style="color: var(--muted); font-weight:800;">Painel interno</div>
        </div>
      </div>

      <h2 class="text-2xl font-extrabold">Entrar</h2>
      <p class="mt-2 text-sm" style="color: var(--muted); font-weight:700;">Use seu e-mail e senha do Firebase Auth.</p>

      <div class="mt-6">
        <label class="text-xs" style="color: var(--muted); font-weight:800;">E-mail</label>
        <input id="adminEmail" type="email" class="field w-full p-4 mt-2" placeholder="seuemail@dominio.com">
      </div>

      <div class="mt-4">
        <label class="text-xs" style="color: var(--muted); font-weight:800;">Senha</label>
        <input id="adminPassword" type="password" class="field w-full p-4 mt-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <button onclick="login()" class="btn btn-primary w-full py-4 mt-6 text-base">Entrar</button>
      <p id="login-feedback" class="mt-4 text-sm hidden" style="color:#ff6b8f; font-weight:900;"></p>

      <div class="mt-6 text-xs" style="color: rgba(237,241,247,.55); font-weight:800;">
        Seguran√ßa por Firebase Auth ‚Ä¢ Asthro
      </div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="content-layer hidden">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-6">
      <!-- Topbar -->
      <div class="glass rounded-2xl p-4 md:p-5 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="flex items-center gap-3">
          <img src="https://i.imgur.com/sE44ypp.png" alt="Asthro" class="h-10 w-auto">
          <div class="leading-tight">
            <div class="text-lg md:text-xl font-extrabold gradient-text" style="font-family:'Archivo',sans-serif;">Asthro Admin</div>
            <div class="text-xs md:text-sm" style="color: var(--muted); font-weight:800;">Status Tracker ‚Ä¢ Projetos</div>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="hidden md:block text-right">
            <div class="text-xs" style="color: var(--muted); font-weight:800;">Logado como</div>
            <div id="whoami" class="text-sm font-extrabold"></div>
          </div>
          <button class="btn btn-ghost" onclick="logout()">Sair</button>
        </div>
      </div>

      <!-- Layout -->
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-6">
        <!-- Sidebar Tabs -->
        <aside class="glass rounded-2xl p-4">
          <div class="text-xs mb-3" style="color: var(--muted); font-weight:900;">NAVEGA√á√ÉO</div>
          <div class="space-y-3">
            <button id="tab-dashboard" class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button id="tab-projects" class="tab" onclick="showTab('projects')">üìÑ Projetos</button>
            <button id="tab-editor" class="tab" onclick="showTab('editor')">‚ú® Novo / Editar</button>
          </div>

          <div class="mt-6 glass rounded-2xl p-4">
            <div class="text-xs" style="color: var(--muted); font-weight:900;">DICAS</div>
            <div class="mt-2 text-xs leading-relaxed" style="color: rgba(237,241,247,.62); font-weight:800;">
              ‚Ä¢ ‚ÄúProjetos‚Äù mostra tudo em tabela<br>
              ‚Ä¢ ‚ÄúEditor‚Äù cria/edita com auditoria<br>
              ‚Ä¢ ‚ÄúDashboard‚Äù traz m√©tricas reais
            </div>
          </div>
        </aside>

        <!-- Main -->
        <main class="space-y-6">
          <!-- DASHBOARD -->
          <section id="view-dashboard" class="glass rounded-2xl p-5 md:p-6">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h3 class="text-2xl font-extrabold gradient-text">Dashboard</h3>
                <p class="mt-1 text-sm" style="color: var(--muted); font-weight:800;">Vis√£o geral e relat√≥rios autom√°ticos.</p>
              </div>
              <button class="btn btn-ghost" onclick="refreshAll()">Atualizar</button>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">TOTAL DE PROJETOS</div>
                <div id="kpiTotal" class="mt-2 text-3xl font-extrabold">‚Äî</div>
              </div>
              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">CRIADOS ESTE M√äS</div>
                <div id="kpiMonth" class="mt-2 text-3xl font-extrabold">‚Äî</div>
              </div>
              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">CRIADOS ESTE ANO</div>
                <div id="kpiYear" class="mt-2 text-3xl font-extrabold">‚Äî</div>
              </div>
              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">CONCLU√çDOS</div>
                <div id="kpiDone" class="mt-2 text-3xl font-extrabold">‚Äî</div>
              </div>
            </div>

            <div class="mt-4 grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">ENTREGUES NO PRAZO</div>
                <div id="kpiOnTime" class="mt-2 text-xl font-extrabold">‚Äî</div>
                <p class="mt-2 text-xs" style="color: rgba(237,241,247,.62); font-weight:800;">
                  Considera ‚Äúconclu√≠do‚Äù e compara <b>finishedAt</b> com <b>deliveryDate</b> (quando dispon√≠vel).
                </p>
              </div>

              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">AUDITORIA (√öLTIMAS 30 DIAS)</div>
                <div id="kpiAudit" class="mt-2 text-xl font-extrabold">‚Äî</div>
                <p class="mt-2 text-xs" style="color: rgba(237,241,247,.62); font-weight:800;">
                  Total de cria√ß√µes/edi√ß√µes registradas em <b>/audit</b>.
                </p>
              </div>
            </div>
          </section>

          <!-- PROJECTS -->
          <section id="view-projects" class="glass rounded-2xl p-5 md:p-6 hidden">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
              <div>
                <h3 class="text-2xl font-extrabold gradient-text">Projetos</h3>
                <p class="mt-1 text-sm" style="color: var(--muted); font-weight:800;">Tabela organizada para achar r√°pido.</p>
              </div>

              <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                <input id="q" class="field p-3 w-full sm:w-72" placeholder="Buscar por ID ou cliente‚Ä¶" oninput="applyFilters()">
                <select id="sort" class="field p-3 w-full sm:w-64" onchange="applyFilters()">
                  <option value="created_desc">Criado (recentes)</option>
                  <option value="created_asc">Criado (antigos)</option>
                  <option value="updated_desc">√öltima edi√ß√£o (recentes)</option>
                  <option value="updated_asc">√öltima edi√ß√£o (antigos)</option>
                  <option value="client_asc">Cliente (A-Z)</option>
                  <option value="client_desc">Cliente (Z-A)</option>
                  <option value="status_asc">Status (ordem)</option>
                </select>
              </div>
            </div>

            <div class="mt-4 overflow-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left" style="color: var(--muted); font-weight:900;">
                    <th class="py-3 pr-4">ID</th>
                    <th class="py-3 pr-4">Cliente</th>
                    <th class="py-3 pr-4">Status</th>
                    <th class="py-3 pr-4">Entrega</th>
                    <th class="py-3 pr-4">Criado</th>
                    <th class="py-3 pr-4">Editado</th>
                    <th class="py-3 pr-4"></th>
                  </tr>
                </thead>
                <tbody id="projectsTbody"></tbody>
              </table>
            </div>

            <div class="mt-4 flex items-center justify-between">
              <div id="projectsMeta" class="text-xs" style="color: var(--muted); font-weight:900;">‚Äî</div>
              <div class="flex gap-2">
                <button class="btn btn-ghost" onclick="prevPage()">Anterior</button>
                <button class="btn btn-ghost" onclick="nextPage()">Pr√≥xima</button>
              </div>
            </div>
          </section>

          <!-- EDITOR -->
          <section id="view-editor" class="glass rounded-2xl p-5 md:p-6 hidden">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h3 id="editorTitle" class="text-2xl font-extrabold gradient-text">Novo projeto</h3>
                <p class="mt-1 text-sm" style="color: var(--muted); font-weight:800;">Crie ou edite com seguran√ßa.</p>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-ghost" onclick="resetForm()">Limpar</button>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="glass-strong rounded-2xl p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div class="md:col-span-2">
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">ID do Projeto</label>
                    <input id="idInput" class="field w-full p-3 mt-2 font-mono" readonly>
                  </div>

                  <div>
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">Criado em</label>
                    <input id="createdAtInput" class="field w-full p-3 mt-2" readonly value="N/A">
                  </div>
                  <div>
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">√öltima edi√ß√£o</label>
                    <input id="lastUpdatedInput" class="field w-full p-3 mt-2" readonly value="N/A">
                  </div>

                  <div class="md:col-span-2">
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">Cliente / Projeto</label>
                    <input id="clientNameInput" class="field w-full p-3 mt-2" placeholder="Ex: Landing Page Empresa X">
                  </div>

                  <div>
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">Status</label>
                    <select id="statusSelect" class="field w-full p-3 mt-2">
                      <option value="setup">Setup Inicial</option>
                      <option value="design_andamento">Design e Cria√ß√£o</option>
                      <option value="dev_andamento">Desenvolvimento</option>
                      <option value="revisao_cliente">Revis√£o do Cliente</option>
                      <option value="concluido">Conclu√≠do</option>
                    </select>
                  </div>

                  <div>
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">Previs√£o de entrega</label>
                    <input id="deliveryDateInput" type="date" class="field w-full p-3 mt-2">
                  </div>

                  <div class="md:col-span-2">
                    <label class="text-xs" style="color: var(--muted); font-weight:900;">Notas</label>
                    <textarea id="notesInput" class="field w-full p-3 mt-2 min-h-[110px]" placeholder="Detalhes da etapa atual, pr√≥ximos passos..."></textarea>
                  </div>
                </div>

                <div class="mt-4 flex flex-col md:flex-row gap-3">
                  <button class="btn btn-primary w-full md:w-auto md:flex-1" onclick="saveProject()">Salvar</button>
                  <button id="finishButton" class="btn btn-ghost w-full md:w-auto md:flex-1 hidden" onclick="openConfirmDialog()">Finalizar</button>
                </div>

                <p id="admin-feedback" class="mt-4 text-sm hidden" style="font-weight:900;"></p>
              </div>

              <div class="glass-strong rounded-2xl p-4">
                <div class="text-xs" style="color: var(--muted); font-weight:900;">STATUS ATUAL</div>
                <div class="mt-2 text-lg font-extrabold" id="statusPreview">‚Äî</div>

                <div class="mt-4">
                  <div class="text-xs" style="color: var(--muted); font-weight:900;">PROGRESSO</div>
                  <div class="mt-2 h-2 rounded-full bg-white/10 overflow-hidden">
                    <div id="progressFill" class="h-full" style="width:0%; background: linear-gradient(90deg, rgba(102,39,255,.95), rgba(11,244,237,.75));"></div>
                  </div>
                  <div id="progressLabel" class="mt-2 text-xs" style="color: var(--muted); font-weight:900;">0%</div>
                </div>

                <div class="mt-6 text-xs leading-relaxed" style="color: rgba(237,241,247,.62); font-weight:800;">
                  ‚Ä¢ O acompanhamento p√∫blico l√™ <b>/projects</b><br>
                  ‚Ä¢ Este painel escreve em <b>/projects</b> e registra em <b>/audit</b><br>
                  ‚Ä¢ Datas suportam Timestamp/ISO sem quebrar
                </div>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>
  </section>

  <script>
    // ========= FIREBASE CONFIG =========
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBb8jAT-VR5723XaxZnH4jcw-PxOlRKn8w",
      authDomain: "asthro-status-tracker.firebaseapp.com",
      projectId: "asthro-status-tracker",
      storageBucket: "asthro-status-tracker.firebasestorage.app",
      messagingSenderId: "1023071296327",
      appId: "1:1023071296327:web:477b39bd6d846fff148a62"
    };

    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const FieldValue = firebase.firestore.FieldValue;

    // ========= STATUS MAP =========
    const statusMap = {
      'setup': { name: 'Setup Inicial', percent: 10 },
      'design_andamento': { name: 'Design e Cria√ß√£o', percent: 35 },
      'dev_andamento': { name: 'Desenvolvimento', percent: 65 },
      'revisao_cliente': { name: 'Revis√£o do Cliente', percent: 85 },
      'concluido': { name: 'Conclu√≠do', percent: 100 }
    };

    // ========= STATE =========
    let allProjects = [];        // { id, ...data }
    let filteredProjects = [];
    let page = 1;
    const PAGE_SIZE = 8;

    // ========= HELPERS (CORRIGE SEU ERRO) =========
    function toMillisAny(v){
      // Firestore Timestamp
      if (v && typeof v === 'object' && typeof v.toMillis === 'function') return v.toMillis();
      // Date
      if (v instanceof Date) return v.getTime();
      // number
      if (typeof v === 'number') return v;
      // string ISO or date string
      if (typeof v === 'string' && v.trim()) {
        const t = Date.parse(v);
        return Number.isNaN(t) ? 0 : t;
      }
      return 0;
    }

    function formatDateTime(v){
      const ms = toMillisAny(v);
      if (!ms) return 'N/A';
      const d = new Date(ms);
      const pad = (n)=> String(n).padStart(2,'0');
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function formatDateOnly(v){
      // usado para deliveryDate (YYYY-MM-DD)
      if (!v) return 'N/A';
      if (typeof v === 'string') return v;
      const ms = toMillisAny(v);
      if (!ms) return 'N/A';
      const d = new Date(ms);
      const pad = (n)=> String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function generateAsthroId(){
      const now = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      const hour = pad(now.getHours());
      const day = pad(now.getDate());
      const minute = pad(now.getMinutes());
      const month = pad(now.getMonth()+1);
      const second = pad(now.getSeconds());
      const year = String(now.getFullYear()).slice(-2);
      return `ASTHRO-${hour}${day}${minute}${month}${second}${year}`;
    }

    function setFeedback(msg, ok=true){
      const el = document.getElementById('admin-feedback');
      el.textContent = msg;
      el.classList.remove('hidden');
      el.style.color = ok ? '#7CFFB2' : '#ff6b8f';
    }

    // ========= AUTH =========
    async function login(){
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPassword').value;
      const fb = document.getElementById('login-feedback');
      fb.classList.add('hidden');
      fb.textContent = '';

      if(!email || !password){
        fb.textContent = 'Preencha e-mail e senha.';
        fb.classList.remove('hidden');
        return;
      }

      try{
        await auth.signInWithEmailAndPassword(email, password);
      }catch(err){
        console.error('Erro no login:', err);
        fb.textContent = `Falha no login: ${err.code || ''} ${err.message || ''}`;
        fb.classList.remove('hidden');
      }
    }

    async function logout(){
      await auth.signOut();
    }

    auth.onAuthStateChanged(async (user)=>{
      const loginSection = document.getElementById('login-section');
      const app = document.getElementById('app');

      if(user){
        loginSection.classList.add('hidden');
        app.classList.remove('hidden');

        document.getElementById('whoami').textContent = user.email || user.uid;

        resetForm();
        showTab('dashboard');
        await refreshAll();
      }else{
        app.classList.add('hidden');
        loginSection.classList.remove('hidden');
      }
    });

    // ========= TABS =========
    function showTab(name){
      const views = ['dashboard','projects','editor'];
      views.forEach(v=>{
        document.getElementById('view-'+v).classList.toggle('hidden', v !== name);
        document.getElementById('tab-'+v).classList.toggle('active', v === name);
      });
    }

    // ========= LOAD =========
    async function refreshAll(){
      await loadProjects();
      applyFilters();   // render table
      await renderDashboard();
    }

    async function loadProjects(){
      // puxa tudo de /projects
      const snap = await db.collection('projects').get();
      allProjects = snap.docs.map(d=>({ id: d.id, ...d.data() }));
      // se tiver projeto sem createdAt, n√£o quebra
      return allProjects;
    }

    // ========= FILTER/SORT/PAGINATE =========
    function applyFilters(){
      const q = (document.getElementById('q')?.value || '').trim().toUpperCase();
      const sort = document.getElementById('sort')?.value || 'created_desc';

      filteredProjects = allProjects.filter(p=>{
        const id = (p.id || '').toUpperCase();
        const client = (p.clientName || '').toUpperCase();
        return !q || id.includes(q) || client.includes(q);
      });

      // Ordena√ß√£o ROBUSTA (sem localeCompare em datas!)
      filteredProjects.sort((a,b)=>{
        const aCreated = toMillisAny(a.createdAt);
        const bCreated = toMillisAny(b.createdAt);
        const aUpd = toMillisAny(a.lastUpdated);
        const bUpd = toMillisAny(b.lastUpdated);

        switch(sort){
          case 'created_asc': return aCreated - bCreated;
          case 'created_desc': return bCreated - aCreated;
          case 'updated_asc': return aUpd - bUpd;
          case 'updated_desc': return bUpd - aUpd;
          case 'client_asc': return String(a.clientName||'').localeCompare(String(b.clientName||''), 'pt-BR');
          case 'client_desc': return String(b.clientName||'').localeCompare(String(a.clientName||''), 'pt-BR');
          case 'status_asc': return String(a.status||'').localeCompare(String(b.status||''), 'pt-BR');
          default: return bCreated - aCreated;
        }
      });

      page = 1;
      renderProjectsTable();
    }

    function renderProjectsTable(){
      const tbody = document.getElementById('projectsTbody');
      const meta = document.getElementById('projectsMeta');
      tbody.innerHTML = '';

      const total = filteredProjects.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      page = Math.min(page, pages);

      const start = (page - 1) * PAGE_SIZE;
      const slice = filteredProjects.slice(start, start + PAGE_SIZE);

      meta.textContent = `Mostrando ${slice.length} de ${total} ‚Ä¢ P√°gina ${page}/${pages}`;

      if(slice.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="py-6" style="color: var(--muted); font-weight:900;">Nenhum projeto encontrado.</td>`;
        tbody.appendChild(tr);
        return;
      }

      slice.forEach(p=>{
        const statusInfo = statusMap[p.status] || { name: '‚Äî', percent: 0 };
        const tr = document.createElement('tr');
        tr.className = "border-t border-white/10";

        tr.innerHTML = `
          <td class="py-3 pr-4 font-mono text-xs md:text-sm">${p.id}</td>
          <td class="py-3 pr-4 font-extrabold">${p.clientName || 'Sem nome'}</td>
          <td class="py-3 pr-4">
            <span class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 text-xs font-extrabold">${statusInfo.name}</span>
          </td>
          <td class="py-3 pr-4 text-sm" style="color: var(--muted); font-weight:900;">${p.deliveryDate || 'N/A'}</td>
          <td class="py-3 pr-4 text-xs" style="color: var(--muted); font-weight:900;">${formatDateTime(p.createdAt)}</td>
          <td class="py-3 pr-4 text-xs" style="color: var(--muted); font-weight:900;">${formatDateTime(p.lastUpdated)}</td>
          <td class="py-3 pr-0 text-right">
            <button class="btn btn-ghost text-xs" onclick="openEdit('${p.id.replace(/'/g,"\\'")}')">Editar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function prevPage(){ page = Math.max(1, page - 1); renderProjectsTable(); }
    function nextPage(){
      const pages = Math.max(1, Math.ceil(filteredProjects.length / PAGE_SIZE));
      page = Math.min(pages, page + 1);
      renderProjectsTable();
    }

    // ========= EDITOR =========
    function resetForm(){
      document.getElementById('editorTitle').textContent = 'Novo projeto';
      document.getElementById('idInput').value = generateAsthroId();
      document.getElementById('clientNameInput').value = '';
      document.getElementById('statusSelect').value = 'setup';
      document.getElementById('deliveryDateInput').value = '';
      document.getElementById('notesInput').value = '';
      document.getElementById('createdAtInput').value = 'N/A';
      document.getElementById('lastUpdatedInput').value = 'N/A';
      document.getElementById('finishButton').classList.add('hidden');
      document.getElementById('admin-feedback').classList.add('hidden');
      updatePreview();
    }

    function updatePreview(){
      const s = document.getElementById('statusSelect').value;
      const info = statusMap[s] || { name: '‚Äî', percent: 0 };
      document.getElementById('statusPreview').textContent = info.name;
      document.getElementById('progressFill').style.width = `${info.percent}%`;
      document.getElementById('progressLabel').textContent = `${info.percent}%`;
    }
    document.getElementById('statusSelect').addEventListener('change', updatePreview);

    async function openEdit(projectId){
      showTab('editor');

      const doc = await db.collection('projects').doc(projectId).get();
      if(!doc.exists){
        setFeedback('Projeto n√£o encontrado para edi√ß√£o.', false);
        return;
      }

      const data = doc.data() || {};
      document.getElementById('editorTitle').textContent = `Editando: ${projectId}`;
      document.getElementById('idInput').value = projectId;
      document.getElementById('clientNameInput').value = data.clientName || '';
      document.getElementById('statusSelect').value = data.status || 'setup';
      document.getElementById('deliveryDateInput').value = data.deliveryDate || '';
      document.getElementById('notesInput').value = data.notes || '';

      document.getElementById('createdAtInput').value = formatDateTime(data.createdAt);
      document.getElementById('lastUpdatedInput').value = formatDateTime(data.lastUpdated);

      const finishBtn = document.getElementById('finishButton');
      finishBtn.classList.remove('hidden');
      finishBtn.setAttribute('data-project-id', projectId);

      updatePreview();
    }

    // ========= SAVE / FINISH =========
    async function saveProject(){
      const projectId = document.getElementById('idInput').value.trim().toUpperCase();
      const clientName = document.getElementById('clientNameInput').value.trim();
      const status = document.getElementById('statusSelect').value;
      const deliveryDate = document.getElementById('deliveryDateInput').value;
      const notes = document.getElementById('notesInput').value.trim();

      if(!projectId || !clientName){
        setFeedback('Nome do cliente √© obrigat√≥rio.', false);
        return;
      }

      try{
        const ref = db.collection('projects').doc(projectId);
        const snap = await ref.get();
        const exists = snap.exists;

        const payload = {
          clientName,
          status,
          deliveryDate,
          notes,
          lastUpdated: FieldValue.serverTimestamp()
        };

        if(!exists){
          payload.createdAt = FieldValue.serverTimestamp();
        }

        await ref.set(payload, { merge: true });

        // auditoria (se regras permitirem)
        try{
          await db.collection('audit').add({
            projectId,
            action: exists ? 'update' : 'create',
            uid: auth.currentUser?.uid || null,
            email: auth.currentUser?.email || null,
            at: FieldValue.serverTimestamp()
          });
        }catch(e){
          console.warn('Audit falhou (regras?)', e);
        }

        setFeedback(`Projeto ${projectId} salvo com sucesso!`, true);

        await refreshAll();
        // mant√©m no editor, mas atualiza campos (created/updated do server)
        await openEdit(projectId);

      }catch(error){
        console.error("Erro ao salvar projeto:", error);
        setFeedback(`Erro ao salvar: ${error.message}`, false);
      }
    }

    function openConfirmDialog(){
      const projectId = document.getElementById('finishButton').getAttribute('data-project-id');
      const dialog = document.getElementById('confirm-dialog');
      document.getElementById('confirm-message').textContent =
        `Tem certeza que deseja FINALIZAR o projeto ${projectId}? Isso marcar√° como "Conclu√≠do".`;

      dialog.classList.remove('hidden');

      const onOk = async () => {
        dialog.classList.add('hidden');
        document.getElementById('confirm-ok').removeEventListener('click', onOk);
        document.getElementById('confirm-cancel').removeEventListener('click', onCancel);
        await finishProject(projectId);
      };
      const onCancel = () => {
        dialog.classList.add('hidden');
        document.getElementById('confirm-ok').removeEventListener('click', onOk);
        document.getElementById('confirm-cancel').removeEventListener('click', onCancel);
      };

      document.getElementById('confirm-ok').addEventListener('click', onOk);
      document.getElementById('confirm-cancel').addEventListener('click', onCancel);
    }

    async function finishProject(projectId){
      try{
        const now = FieldValue.serverTimestamp();
        const today = new Date();
        const pad = (n)=> String(n).padStart(2,'0');
        const dateOnly = `${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}`;

        await db.collection('projects').doc(projectId).update({
          status: 'concluido',
          lastUpdated: now,
          finishedAt: now,
          deliveryDate: dateOnly
        });

        try{
          await db.collection('audit').add({
            projectId,
            action: 'finish',
            uid: auth.currentUser?.uid || null,
            email: auth.currentUser?.email || null,
            at: now
          });
        }catch(e){
          console.warn('Audit finish falhou', e);
        }

        setFeedback(`Projeto ${projectId} finalizado com sucesso!`, true);
        await refreshAll();
        await openEdit(projectId);

      }catch(error){
        console.error("Erro ao finalizar:", error);
        setFeedback(`Erro ao finalizar: ${error.message}`, false);
      }
    }

    // ========= DASHBOARD =========
    async function renderDashboard(){
      // KPIs de projects
      const total = allProjects.length;
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth(); // 0-11

      let createdThisYear = 0;
      let createdThisMonth = 0;
      let done = 0;
      let onTime = 0;

      allProjects.forEach(p=>{
        const c = new Date(toMillisAny(p.createdAt) || 0);
        if (c.getFullYear() === year) createdThisYear++;
        if (c.getFullYear() === year && c.getMonth() === month) createdThisMonth++;

        if (p.status === 'concluido') {
          done++;
          // entrega no prazo: finishedAt <= deliveryDate (se existir)
          if (p.deliveryDate && p.finishedAt){
            const finishedMs = toMillisAny(p.finishedAt);
            const deliveryMs = Date.parse(p.deliveryDate + "T23:59:59");
            if (finishedMs && deliveryMs && finishedMs <= deliveryMs) onTime++;
          }
        }
      });

      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiMonth').textContent = createdThisMonth;
      document.getElementById('kpiYear').textContent = createdThisYear;
      document.getElementById('kpiDone').textContent = done;
      document.getElementById('kpiOnTime').textContent = `${onTime} / ${done}`;

      // Auditoria √∫ltimos 30 dias
      try{
        const since = new Date();
        since.setDate(since.getDate() - 30);

        // "at" √© serverTimestamp -> Timestamp
        const snap = await db.collection('audit').where('at', '>=', since).get();
        document.getElementById('kpiAudit').textContent = `${snap.size} eventos`;
      }catch(e){
        console.warn('Falha ao ler audit (regras?)', e);
        document.getElementById('kpiAudit').textContent = 'Sem acesso';
      }
    }

    // ========= ENTER TO LOGIN =========
    document.addEventListener('DOMContentLoaded', ()=>{
      const pass = document.getElementById('adminPassword');
      const email = document.getElementById('adminEmail');
      if(email) email.addEventListener('keypress', e=>{ if(e.key==='Enter') login(); });
      if(pass) pass.addEventListener('keypress', e=>{ if(e.key==='Enter') login(); });
      updatePreview();
    });

    // ========= STARS =========
    const starsContainer = document.getElementById('stars-container');
    function createStars(){
      if(!starsContainer) return;
      starsContainer.innerHTML = '';
      const colors = ['purple','cyan','white'];
      const numStars = 140;
      for(let i=0;i<numStars;i++){
        const s = document.createElement('span');
        s.classList.add('star', colors[Math.floor(Math.random()*colors.length)]);
        s.style.left = `${Math.random()*window.innerWidth}px`;
        s.style.top  = `${Math.random()*window.innerHeight}px`;
        const mx = (Math.random()-0.5)*260;
        const my = (Math.random()-0.5)*260;
        s.style.setProperty('--mx', `${mx}px`);
        s.style.setProperty('--my', `${my}px`);
        s.style.animationDelay = `${Math.random()*16}s`;
        starsContainer.appendChild(s);
      }
    }
    createStars();
    window.addEventListener('resize', createStars);
  </script>
</body>
</html>
