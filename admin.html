<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asthro | Painel de Administra√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@700&family=Manrope:wght@400;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.imgur.com/ZeaGXHD.png">

    <style>
    /* Tipografia Padronizada */
    h2, h3, h4 { font-family: 'Archivo', sans-serif; }
    body, p, a, input, button, select, textarea { font-family: 'Manrope', sans-serif; font-weight: 400; }
    
    /* Fundo Escuro para Estilo de Sistema */
    body { 
        background: #0d0d1a; /* Roxo escuro para base */
        color: #edf1f7; 
        min-height: 100vh;
        overflow-x: hidden; /* Evita barra de rolagem horizontal */
    }
    
    /* Efeito de Neon Animado para T√≠tulos */
    @keyframes neon-glow {
        0% { text-shadow: 0 0 5px #0bf4ed, 0 0 10px #0bf4ed; color: #0bf4ed; }
        25% { text-shadow: 0 0 5px #6627ff, 0 0 10px #6627ff; color: #6627ff; }
        50% { text-shadow: 0 0 5px #ff2766, 0 0 10px #ff2766; color: #ff2766; }
        75% { text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700; color: #ffd700; }
        100% { text-shadow: 0 0 5px #0bf4ed, 0 0 10px #0bf4ed; color: #0bf4ed; }
    }

    .animated-neon-text {
        animation: neon-glow 6s ease-in-out infinite alternate;
        -webkit-text-fill-color: initial; /* Anula o gradient-text */
    }

    /* Borda e Sombra de Container */
    .neon-border { 
        border: 1px solid rgba(102, 39, 255, 0.4); 
        box-shadow: 0 0 15px rgba(11, 244, 237, 0.3); 
        background-color: #1a1a2e; /* Fundo do card mais escuro */
    }

    /* Para manter a barra lateral fixa e o conte√∫do rol√°vel */
    .dashboard-grid {
        display: grid;
        /* Sidebar de 250px, e o restante para o conte√∫do */
        grid-template-columns: 250px 1fr; 
        min-height: 100vh;
    }
    
    /* Estilo para a caixa de di√°logo de confirma√ß√£o (sem altera√ß√£o) */
    .custom-dialog {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center;
        z-index: 100;
    }
</style>
</head>
<body class="p-0"> <div id="confirm-dialog" class="custom-dialog hidden">
        <div class="p-6 rounded-xl bg-gray-900 neon-border max-w-sm w-full">
            <h4 class="text-xl font-bold text-white mb-4">Confirma√ß√£o</h4>
            <p id="confirm-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Cancelar</button>
                <button id="confirm-ok" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Finalizar</button>
            </div>
        </div>
    </div>


    <div id="login-section" class="flex items-center justify-center min-h-screen">
  <div class="max-w-md w-full mx-auto p-8 rounded-xl bg-gray-900 neon-border">
    <h3 class="text-3xl font-bold text-center mb-6 animated-neon-text" style="font-family: 'Archivo', sans-serif;">
      üîí Acesso Asthro Admin
    </h3>

    <input
      type="email"
      id="adminEmail"
      placeholder="Seu e-mail de admin"
      class="w-full p-4 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500 mb-4 text-lg"
    >

    <input
      type="password"
      id="adminPassword"
      placeholder="Sua senha"
      class="w-full p-4 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500 mb-4 text-lg"
    >

    <button onclick="login()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-lg transition duration-300 w-full text-xl shadow-lg shadow-indigo-500/50">
      ENTRAR
    </button>

    <p id="login-feedback" class="mt-4 text-red-400 text-center hidden">Falha no login.</p>
  </div>
</div>


    <div id="admin-panel" class="dashboard-grid hidden"> <aside class="bg-gray-950 border-r border-gray-800 p-6 flex flex-col justify-between fixed h-full w-[250px]">
            <div>
                <h1 class="text-2xl font-bold animated-neon-text mb-8" style="font-family: 'Archivo', sans-serif;">üåå ASTHRO Admin</h1>
                
                <nav class="space-y-4">
                    <button onclick="resetForm(); scrollToTop()" class="flex items-center w-full text-left p-3 rounded-lg bg-purple-900/50 hover:bg-purple-800/70 text-purple-300 font-semibold transition duration-300 border border-purple-700 shadow-lg shadow-purple-900/40">
                        ‚ú® Criar Novo Projeto
                    </button>
                    <button onclick="loadProjects(1); scrollToProjects()" class="flex items-center w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 transition duration-300">
                        üìÑ Ver/Editar Projetos
                    </button>
                    <button class="flex items-center w-full text-left p-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-gray-300 transition duration-300 opacity-50 cursor-not-allowed">
                        üìä Relat√≥rios (Em breve)
                    </button>
                </nav>
            </div>
            
            <div class="text-sm text-gray-500">
                <p>Status Tracker v1.0</p>
                <p class="mt-1">Desenvolvido por Asthro</p>
            </div>
        </aside>

        <main class="col-start-2 p-10">
    
    <div class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-5 gap-10">
        
        <div class="lg:col-span-2 xl:col-span-3">
            <section id="project-list-section">
                <h3 class="text-2xl font-bold text-cyan-400 mb-6">üìÇ Projetos Existentes</h3>
                
                <section id="search-section" class="mb-8">
                    <h4 class="text-xl font-bold text-purple-400 mb-4">üîç Gerenciamento R√°pido</h4>
                    
                    <div class="flex flex-col md:flex-row gap-4 items-stretch p-6 rounded-xl bg-gray-900 border border-gray-800">
                        <div class="w-full md:w-auto flex-shrink-0">
                            <select id="orderBySelect" onchange="loadProjects(1)" 
                                class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500 appearance-none pr-8">
                                <option value="status_id_desc">‚ú® Prioridade/Status</option>
                                <option value="id_desc">üóìÔ∏è Mais Recentes</option>
                                <option value="id_asc">‚è≥ Mais Antigos</option>
                                <option value="clientName_asc">A-Z</option>
                                <option value="clientName_desc">Z-A</option>
                            </select>
                        </div>

                        <div class="flex space-x-4 items-stretch w-full">
                            <input type="text" id="searchInput" placeholder="Buscar por ID ou Nome do Cliente..."
                                class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500"
                                onkeyup="debouncedSearch()" onchange="debouncedSearch()">
                            
                            <button onclick="clearSearchAndReload()"
                                class="bg-pink-600 hover:bg-pink-700 text-white font-semibold px-6 rounded-lg transition duration-300 whitespace-nowrap shadow-md">
                                Limpar Busca
                            </button>
                        </div>
                    </div>
                    <p id="search-feedback" class="mt-2 text-sm text-gray-400 hidden"></p>
                </section>
                
                <div id="project-list" class="space-y-6">
                    <p class="text-gray-500">Carregando projetos...</p>
                </div>
                <div id="pagination-container" class="mt-8"></div>
            </section>
        </div>

        <div class="lg:col-span-1 xl:col-span-2">
            <section id="form-section">
                <div class="p-8 rounded-2xl neon-border shadow-xl shadow-cyan-900/30 sticky top-10">
                    <h3 class="text-3xl font-bold text-cyan-400 mb-8" id="form-title">‚ú® Criar Novo Projeto</h3>
                    
                    <div class="mb-6 grid grid-cols-1 gap-4">
                        <div>
                            <label for="idInput" class="block text-sm font-medium text-gray-400 mb-1">ID do Projeto</label>
                            <input type="text" id="idInput" value="" readonly class="w-full p-3 rounded-lg bg-gray-800 text-indigo-400 font-mono text-lg border border-gray-700">
                        </div>
                        <div id="audit-fields-container" class="grid grid-cols-2 gap-4 form-audit-field hidden">
                            <div>
                                <label for="createdAtInput" class="block text-sm font-medium text-gray-400 mb-1">Criado em</label>
                                <input type="text" id="createdAtInput" value="N/A" readonly class="w-full p-3 rounded-lg bg-gray-800 text-gray-300 border border-gray-700 text-sm">
                            </div>
                            <div>
                                <label for="lastUpdatedInput" class="block text-sm font-medium text-gray-400 mb-1">√öltima Edi√ß√£o</label>
                                <input type="text" id="lastUpdatedInput" value="N/A" readonly class="w-full p-3 rounded-lg bg-gray-800 text-gray-300 border border-gray-700 text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="clientNameInput" class="block text-sm font-medium text-gray-400 mb-1">Nome do Cliente / Projeto</label>
                        <input type="text" id="clientNameInput" placeholder="Ex: Projeto Landing Page Empresa X" class="w-full p-4 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 text-xl">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="statusSelect" class="block text-sm font-medium text-gray-400 mb-1">Status Atual</label>
                            <select id="statusSelect" class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                                <option value="setup">Setup Inicial</option>
                                <option value="design_andamento">Design e Cria√ß√£o</option>
                                <option value="dev_andamento">Desenvolvimento</option>
                                <option value="revisao_cliente">Revis√£o do Cliente</option>
                            </select>
                        </div>
                        <div>
                            <label for="deliveryDateInput" class="block text-sm font-medium text-gray-400 mb-1">Previs√£o de Entrega</label>
                            <input type="date" id="deliveryDateInput" class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                    </div>

                    <div class="mb-8">
                        <label for="notesInput" class="block text-sm font-medium text-gray-400 mb-1">Notas do Consultor</label>
                        <textarea id="notesInput" placeholder="Detalhes da etapa atual ou pr√≥ximos passos." class="w-full p-3 rounded-lg bg-gray-800 text-white border border-gray-700 focus:ring-cyan-500 focus:border-cyan-500 h-24"></textarea>
                    </div>

                    <div class="flex flex-col gap-3 md:flex-row md:gap-4">
    <button id="cancelButton" onclick="resetForm()" class="hidden bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex-1 order-3 md:order-1 text-sm">
        ‚ùå Cancelar
    </button>

    <button id="finishButton" onclick="openConfirmDialog()" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex-1 order-1 md:order-2 shadow-md hover:shadow-lg text-sm">Finalizar Projeto</button>
    
    <button onclick="saveProject()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex-1 order-2 md:order-3 shadow-lg shadow-purple-500/50 hover:shadow-xl text-sm">Salvar / Atualizar Projeto</button>
</div>
                    
                    <p id="admin-feedback" class="mt-4 hidden text-center"></p>
                </div>
            </section>
        </div>
        
    </div>
</main>
        
    </div>


    <script>
        function checkFormDirty() {
    const clientName = document.getElementById('clientNameInput').value.trim();
    const deliveryDate = document.getElementById('deliveryDateInput').value;
    const notes = document.getElementById('notesInput').value.trim();
    const status = document.getElementById('statusSelect').value;
    
    const cancelButton = document.getElementById('cancelButton');
    
    // O formul√°rio est√° "sujo" se:
    // 1. O Nome do Cliente N√ÉO estiver vazio, OU
    // 2. A Data de Entrega N√ÉO estiver vazia, OU
    // 3. As Notas N√ÉO estiverem vazias, OU
    // 4. O Status N√ÉO for o valor padr√£o 'setup'.
    const isDirty = clientName.length > 0 || 
                    deliveryDate.length > 0 || 
                    notes.length > 0 ||
                    status !== 'setup';
                    
    if (isDirty) {
        cancelButton.classList.remove('hidden');
    } else {
        cancelButton.classList.add('hidden');
    }
}

// üìå ADICIONE ESTE BLOCO DE EVENT LISTENERS (DEPOIS DAS FUN√á√ïES)
// Garante que a fun√ß√£o checkFormDirty seja chamada toda vez que o usu√°rio interagir com o formul√°rio
document.addEventListener('DOMContentLoaded', () => {
    // Campos que devem ser monitorados
    const monitoredFields = [
        document.getElementById('clientNameInput'),
        document.getElementById('deliveryDateInput'),
        document.getElementById('notesInput'),
        document.getElementById('statusSelect')
    ];

    monitoredFields.forEach(field => {
        // 'input' funciona para texto, 'change' funciona para select/date
        field.addEventListener('input', checkFormDirty);
        field.addEventListener('change', checkFormDirty);
    });
    
    // Checagem inicial ao carregar a p√°gina
    checkFormDirty(); 
});
        function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function scrollToProjects() {
        // Rola at√© a se√ß√£o de Projetos Existentes
        document.getElementById('project-list-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
        // SUAS CREDENCIAIS DO FIREBASE
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBb8jAT-VR5723XaxZnH4jcw-PxOlRKn8w", 
            authDomain: "asthro-status-tracker.firebaseapp.com",
            projectId: "asthro-status-tracker",
            storageBucket: "asthro-status-tracker.firebasestorage.app",
            messagingSenderId: "1023071296327",
            appId: "1:1023071296327:web:477b39bd6d846fff148a62"
        };
    
        // Inicializa o Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
const auth = firebase.auth();

        // Vari√°veis de Pagina√ß√£o
        const PROJECTS_PER_PAGE = 6;
const HOME_PAGE_PROJECTS = 1; // üëà AGORA MOSTRA APENAS UM PROJETO NA P√ÅGINA INICIAL
let currentPage = 1;
let totalPages = 1;
let searchTimeout = null;
        const projectListElement = document.getElementById('project-list');
        const adminFeedbackElement = document.getElementById('admin-feedback');
        
        // Mapeamento de Status
        const statusMap = {
            'setup': { name: 'Setup Inicial', percent: 10 },
            'design_andamento': { name: 'Design e Cria√ß√£o', percent: 35 },
            'dev_andamento': { name: 'Desenvolvimento em Andamento', percent: 65 },
            'revisao_cliente': { name: 'Revis√£o do Cliente', percent: 85 },
            'concluido': { name: 'CONCLU√çDO', percent: 100 }
        };
        function clearSearchAndReload() {
    document.getElementById('searchInput').value = '';
    loadProjects(1);
}
function pad(num) {
    return num.toString().padStart(2, '0');
}
// üÜï FUN√á√ÉO PARA FORMATAR DATA E HORA
function formatDateTime(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    const day = pad(date.getDate());
    const month = pad(date.getMonth() + 1);
    const year = date.getFullYear();
    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    const seconds = pad(date.getSeconds());
    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}
// üÜï FUN√á√ÉO PARA GERAR ID AUTOM√ÅTICO BASEADO NA DATA E HORA
function generateAsthroId() {
    const now = new Date();
    
    // Captura as partes no formato solicitado
    const hour = pad(now.getHours()); // HH
    const day = pad(now.getDate());   // DD
    const minute = pad(now.getMinutes()); // MM
    const month = pad(now.getMonth() + 1); // MM (meses s√£o 0-11)
    const second = pad(now.getSeconds()); // SS
    const year = now.getFullYear().toString().substring(2); // AA (√∫ltimos 2 d√≠gitos)
    
    // Formato: Asthro-HH,DD,MM,MM,SS,AA (onde o segundo 'MM' √© o m√™s)
    const trackingId = `ASTHRO-${hour}${day}${minute}${month}${second}${year}`;
    
    return trackingId;
}
        async function login() {
  const email = document.getElementById('adminEmail').value.trim();
  const password = document.getElementById('adminPassword').value;
  const feedback = document.getElementById('login-feedback');

  feedback.classList.add('hidden');
  feedback.textContent = '';

  if (!email || !password) {
    feedback.textContent = "Preencha e-mail e senha.";
    feedback.classList.remove('hidden');
    return;
  }

  try {
    await auth.signInWithEmailAndPassword(email, password);

    // Se logou, o onAuthStateChanged (abaixo) vai liberar o painel
  } catch (err) {
  console.error("Erro no login:", err);

  // Mostra o erro REAL do Firebase na tela
  feedback.textContent = `Falha no login: ${err.code || ''} ${err.message || ''}`;
  feedback.classList.remove('hidden');
}
}
        auth.onAuthStateChanged((user) => {
  const loginSection = document.getElementById('login-section');
  const adminPanel = document.getElementById('admin-panel');

  if (user) {
    // Usu√°rio logado
    loginSection.classList.add('hidden');
    adminPanel.classList.remove('hidden');

    resetForm();
    loadProjects(1);
  } else {
    // Usu√°rio deslogado
    adminPanel.classList.add('hidden');
    loginSection.classList.remove('hidden');
  }
});
       function resetForm() {
    document.getElementById('form-title').textContent = 'Criar Novo Projeto';
    document.getElementById('audit-fields-container').classList.add('hidden');
    document.getElementById('idInput').value = generateAsthroId();
    
    // Limpeza dos campos
    document.getElementById('clientNameInput').value = '';
    document.getElementById('statusSelect').value = 'setup'; // Valor padr√£o
    document.getElementById('deliveryDateInput').value = '';
    document.getElementById('notesInput').value = '';
    
    document.getElementById('createdAtInput').value = 'N/A';
    document.getElementById('lastUpdatedInput').value = 'N/A';
    document.getElementById('finishButton').classList.add('hidden');
    
    // üéØ NOVO: Verifica o estado do formul√°rio. Como todos est√£o limpos, o bot√£o 'Cancelar' ser√° ocultado.
    checkFormDirty(); 
    
    loadProjects(1);
    scrollToTop();
}
        // Fun√ß√£o para mostrar o di√°logo de confirma√ß√£o (substitui confirm())
        function openConfirmDialog() {
            const projectId = document.getElementById('finishButton').getAttribute('data-project-id');
            const dialog = document.getElementById('confirm-dialog');
            document.getElementById('confirm-message').textContent = 
                `Tem certeza que deseja FINALIZAR e ARQUIVAR o projeto ${projectId}? O ID ficar√° dispon√≠vel para reutiliza√ß√£o.`;
            
            dialog.classList.remove('hidden');

            const handleFinish = () => {
                finishProject(projectId);
                dialog.classList.add('hidden');
                document.getElementById('confirm-ok').removeEventListener('click', handleFinish);
            };

            const handleCancel = () => {
                dialog.classList.add('hidden');
                document.getElementById('confirm-cancel').removeEventListener('click', handleCancel);
            };

            document.getElementById('confirm-ok').addEventListener('click', handleFinish);
            document.getElementById('confirm-cancel').addEventListener('click', handleCancel);
        }


        function editProject(projectId) {
¬† ¬† ¬† ¬† ¬† ¬† db.collection('projects').doc(projectId).get().then(doc => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (doc.exists) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const data = doc.data();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('form-title').textContent = `Editar Projeto: ${projectId}`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('idInput').value = projectId;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // document.getElementById('idInput').disabled = true; // Mantido readonly no HTML
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('clientNameInput').value = data.clientName || '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('statusSelect').value = data.status || 'setup'; 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('deliveryDateInput').value = data.deliveryDate || '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('notesInput').value = data.notes || '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // üÜï PREENCHE OS CAMPOS DE DATA/HORA
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('createdAtInput').value = formatDateTime(data.createdAt);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('lastUpdatedInput').value = formatDateTime(data.lastUpdated);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // üÜï Sempre exibe o bot√£o Finalizar/Arquivar na edi√ß√£o
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const finishButton = document.getElementById('finishButton');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† finishButton.classList.remove('hidden'); // Torna vis√≠vel
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† finishButton.setAttribute('data-project-id', projectId);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† window.scrollTo(0, 0); // Rola para o topo para ver o formul√°rio
                    checkFormDirty();

    scrollToTop();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }).catch(error => console.error("Erro ao buscar projeto para edi√ß√£o:", error));
¬† ¬† ¬† ¬† }

       async function finishProject(projectId) {
    try {
        const now = new Date().toISOString(); // üÜï Captura Data/Hora completa (ISO string)
        
        // Atualiza o projeto para o status "concluido"
        await db.collection('projects').doc(projectId).update({
            status: 'concluido',
            notes: 'Projeto formalmente FINALIZADO e ENTREGUE.',
            deliveryDate: new Date().toISOString().split('T')[0], // Mant√©m s√≥ a data para o campo de previs√£o
            lastUpdated: now, // üÜï Registra a hora da finaliza√ß√£o como √∫ltima edi√ß√£o
            finishedAt: now // üÜï NOVO CAMPO: Registra a hora exata da conclus√£o
        });
        
        adminFeedbackElement.textContent = `Projeto ${projectId} FINALIZADO com sucesso!`;
        adminFeedbackElement.className = 'mt-4 text-green-400';
        adminFeedbackElement.classList.remove('hidden');
        
        resetForm();
        loadProjects();
        
    } catch (error) {
        console.error("Erro ao finalizar projeto:", error);
        adminFeedbackElement.textContent = "Erro ao finalizar: Verifique as permiss√µes.";
        adminFeedbackElement.className = 'mt-4 text-red-400';
        adminFeedbackElement.classList.remove('hidden');
    }
}


        async function saveProject() {
    const projectId = document.getElementById('idInput').value.trim().toUpperCase();
    const clientName = document.getElementById('clientNameInput').value.trim();
    const status = document.getElementById('statusSelect').value;
    const deliveryDate = document.getElementById('deliveryDateInput').value;
    const notes = document.getElementById('notesInput').value.trim();

    // üÜï VARI√ÅVEIS DE DATA E HORA
    const now = new Date(); // Data/Hora atual para √∫ltima edi√ß√£o
    const timestampUpdate = now.toISOString();
    const isCreationMode = document.getElementById('form-title').textContent.includes('Criar Novo');

    if (!projectId || !clientName || !status) {
        adminFeedbackElement.textContent = "Nome do Cliente e ID do Projeto s√£o obrigat√≥rios.";
        adminFeedbackElement.className = 'mt-4 text-red-400';
        adminFeedbackElement.classList.remove('hidden');
        return;
    }

    try {
        const docRef = db.collection('projects').doc(projectId);
        let projectData = {
            clientName: clientName,
            status: status,
            deliveryDate: deliveryDate,
            notes: notes,
            // üÜï SEMPRE ATUALIZA A DATA DE √öLTIMA EDI√á√ÉO
            lastUpdated: timestampUpdate 
        };
        
        // Se for modo de cria√ß√£o, verifica se j√° existe e adiciona o campo de cria√ß√£o
        if (isCreationMode) {
            const existingDoc = await docRef.get();
            if (existingDoc.exists) {
                const existingData = existingDoc.data();
                
                // Se o projeto j√° existe e N√ÉO est√° conclu√≠do, BLOQUEIA a sobrescrita
                if (existingData.status !== 'concluido') {
                    adminFeedbackElement.textContent = `ERRO: J√° existe um projeto ATIVO (${existingData.clientName}, Status: ${statusMap[existingData.status].name}) com o ID ${projectId}. Tente novamente em 1 minuto.`;
                    adminFeedbackElement.className = 'mt-4 text-red-400';
                    adminFeedbackElement.classList.remove('hidden');
                    return;
                }
            }
            
            // üÜï ADICIONA A HORA DE CRIA√á√ÉO SOMENTE NA CRIA√á√ÉO INICIAL
            projectData.createdAt = timestampUpdate; 
        }

        // --- Salva ou Atualiza o Projeto ---
        await docRef.set(projectData, { merge: true });

        adminFeedbackElement.textContent = `Projeto ${projectId} salvo com sucesso!`;
        adminFeedbackElement.className = 'mt-4 text-green-400';
        adminFeedbackElement.classList.remove('hidden');

        resetForm();
        loadProjects();

    } catch (error) {
        console.error("Erro ao salvar projeto:", error);
        adminFeedbackElement.textContent = "Erro ao salvar: Verifique suas permiss√µes do Firestore.";
        adminFeedbackElement.className = 'mt-4 text-red-400';
        adminFeedbackElement.classList.remove('hidden');
    }
}
function debouncedSearch() {
            // Limpa o timer anterior para n√£o chamar a fun√ß√£o imediatamente
            clearTimeout(searchTimeout);
            // Configura um novo timer para chamar loadProjects em 500ms
            searchTimeout = setTimeout(() => {
                loadProjects(1); // Sempre volta para a primeira p√°gina ao pesquisar
            }, 500);
        }
        
        function updateSearchFeedback(searchText, totalResults) {
            const feedbackElement = document.getElementById('search-feedback');
            if (searchText) {
                feedbackElement.textContent = `Mostrando ${totalResults} resultado(s) para: "${searchText}"`;
                feedbackElement.classList.remove('hidden');
                feedbackElement.classList.remove('text-red-400');
                feedbackElement.classList.add('text-green-400');
            } else {
                feedbackElement.classList.add('hidden');
            }
        }
        async function loadProjects(page = 1) {
    projectListElement.innerHTML = '';
    currentPage = page;
    document.getElementById('pagination-container').innerHTML = '';

    const searchInput = document.getElementById('searchInput');
    const orderBySelect = document.getElementById('orderBySelect'); // üÜï Pega o elemento Select
    
    // Pega o valor da ordena√ß√£o
    const selectedOrder = orderBySelect ? orderBySelect.value : 'status_id_desc'; 
    const searchText = searchInput ? searchInput.value.trim().toUpperCase() : '';
    
    // Vari√°vel para armazenar todos os documentos se houver pesquisa ou para contagem
    let allDocs = [];
    let isSearching = !!searchText;

    try {
        // 1. QUERY DE BUSCA BASE - L√ìGICA DE ORDENA√á√ÉO
        let baseQuery = db.collection('projects');
        
        switch (selectedOrder) {
            case 'clientName_asc':
                baseQuery = baseQuery.orderBy('clientName', 'asc');
                break;
            case 'clientName_desc':
                baseQuery = baseQuery.orderBy('clientName', 'desc');
                break;
            case 'id_asc':
                baseQuery = baseQuery.orderBy(firebase.firestore.FieldPath.documentId(), 'asc');
                break;
            case 'id_desc':
                baseQuery = baseQuery.orderBy(firebase.firestore.FieldPath.documentId(), 'desc');
                break;
            case 'status_id_desc':
            default:
                // Padr√£o: Ordena por Status e depois por ID (Mais Recente)
                baseQuery = baseQuery.orderBy('status', 'asc')
                                     .orderBy(firebase.firestore.FieldPath.documentId(), 'desc');
        }
                
                // Se houver pesquisa, faremos a busca no cliente (browser)
                if (isSearching) {
                    projectListElement.innerHTML = '<p class="text-gray-500">Buscando...</p>';
                    // Pega TODOS os projetos para filtro local (limita√ß√£o do Firestore)
                    const snapshot = await baseQuery.get();
                    
                    // Armazena todos os documentos
                    allDocs = snapshot.docs;
                    
                    // Filtra localmente por ID OU Nome do Cliente
                    const filteredDocs = allDocs.filter(doc => {
                        const data = doc.data();
                        const projectId = doc.id.toUpperCase();
                        const clientName = data.clientName ? data.clientName.toUpperCase() : '';

                        return projectId.includes(searchText) || clientName.includes(searchText);
                    });

                    allDocs = filteredDocs; // Agora allDocs cont√©m apenas os resultados filtrados
                    
                    updateSearchFeedback(searchText, allDocs.length);
                    
                } else {
                    // SE N√ÉO ESTIVER PESQUISANDO, MANT√âM A L√ìGICA DE PAGINA√á√ÉO
                    
                    const countSnapshot = await baseQuery.get();
                    const totalActiveProjects = countSnapshot.docs.length; // Pega todos para contagem
                    
                    // Calcula o total de p√°ginas (al√©m da Home Page)
                    const projectsAfterHome = Math.max(0, totalActiveProjects - HOME_PAGE_PROJECTS);
                    totalPages = Math.ceil(projectsAfterHome / PROJECTS_PER_PAGE);

                    let query = baseQuery;
                    
                    // L√≥gica de Pagina√ß√£o (a mesma que voc√™ j√° tinha)
                    if (currentPage === 1) {
                        query = baseQuery.limit(HOME_PAGE_PROJECTS);
                    } else {
                        const docsToSkip = HOME_PAGE_PROJECTS + (currentPage - 2) * PROJECTS_PER_PAGE;
                        if (docsToSkip > 0) {
                            const startDocSnapshot = await baseQuery.limit(docsToSkip).get();
                            if (!startDocSnapshot.empty) {
                                const startDoc = startDocSnapshot.docs[startDocSnapshot.docs.length - 1];
                                query = baseQuery.startAfter(startDoc).limit(PROJECTS_PER_PAGE);
                            } else {
                                projectListElement.innerHTML = '<p class="text-gray-500">Nenhum projeto encontrado nesta p√°gina.</p>';
                                updateSearchFeedback(searchText, 0);
                                return;
                            }
                        } else {
                            query = baseQuery.limit(HOME_PAGE_PROJECTS);
                        }
                    }
                    
                    const snapshot = await query.get();
                    allDocs = snapshot.docs; // Armazena os documentos da p√°gina atual

                    updateSearchFeedback(searchText, allDocs.length); // Limpa o feedback de pesquisa
                }

                
                // 2. RENDERIZA√á√ÉO DOS PROJETOS (para pesquisa E pagina√ß√£o)
                if (allDocs.length === 0) {
                    projectListElement.innerHTML = `<p class="text-gray-500">${isSearching ? 'Nenhum resultado encontrado para a pesquisa.' : 'Nenhum projeto cadastrado ativo.'}</p>`;
                    // Renderiza pagina√ß√£o apenas se n√£o estiver pesquisando
                    if (!isSearching) renderPaginationControls(totalPages);
                    return;
                }

                projectListElement.innerHTML = '';
                allDocs.forEach(doc => {
                    const data = doc.data();
                    const statusInfo = statusMap[data.status] || { name: 'Desconhecido', percent: 0 };

                    const created = formatDateTime(data.createdAt);
                    const updated = formatDateTime(data.lastUpdated);
                    const finished = data.finishedAt ? formatDateTime(data.finishedAt) : null;
                    
                    // Define classes de cor e borda baseadas no status
                    let cardBorderClass = 'border-gray-700';
                    let statusColorClass = 'text-purple-400';
                    let progressBarColor = 'bg-purple-600';
                    let progressText = statusInfo.percent > 0 ? `${statusInfo.percent}%` : '';

                    if (data.status === 'concluido') {
                        cardBorderClass = 'border-green-500 shadow-lg shadow-green-700/30';
                        statusColorClass = 'text-green-400';
                        progressBarColor = 'bg-green-600';
                        progressText = '100%';
                    } else if (data.status === 'revisao_cliente') {
                        cardBorderClass = 'border-yellow-500 shadow-lg shadow-yellow-700/30';
                        statusColorClass = 'text-yellow-400';
                        progressBarColor = 'bg-yellow-600';
                    }

                    const projectCard = document.createElement('div');
                    projectCard.className = `p-6 bg-gray-900 rounded-xl transition-all duration-300 ease-in-out hover:scale-[1.01] ${cardBorderClass} border-2`;
                    
                    projectCard.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-xl font-bold gradient-text mb-1">${data.clientName}</h4>
                                <p class="text-sm text-gray-400 font-mono">ID: <span class="text-indigo-400 font-semibold">${doc.id}</span></p>
                            </div>
                            <button onclick="editProject('${doc.id}')" 
                                    class="bg-purple-700 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition duration-300 flex-shrink-0">
                                Editar
                            </button>
                        </div>

                        <div class="mb-4">
                            <p class="text-base text-gray-300">Status Atual: <span class="${statusColorClass} font-bold">${statusInfo.name}</span></p>
                            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                                <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${statusInfo.percent}%"></div>
                            </div>
                            <p class="text-right text-xs text-gray-400 mt-1">${progressText}</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-y-2 mb-4 text-sm text-gray-400">
                            <div><span class="font-medium text-gray-300">Previs√£o de Entrega:</span> ${data.deliveryDate || 'N/A'}</div>
                            ${finished ? `<div class="md:col-span-2 text-green-400 font-bold">‚úÖ Projeto Conclu√≠do em: ${finished}</div>` : ''}
                            <div><span class="font-medium text-gray-300">Criado em:</span> ${created}</div>
                            <div><span class="font-medium text-gray-300">√öltima Edi√ß√£o:</span> ${updated}</div>
                        </div>

                        ${data.notes ? `
                            <div class="border-t border-gray-700 pt-4 mt-4">
                                <p class="text-xs text-gray-400 font-medium mb-1">Notas do Consultor:</p>
                                <p class="text-sm text-gray-300 italic">${data.notes}</p>
                            </div>
                        ` : ''}
                    `;
                    projectListElement.appendChild(projectCard);
                });

                // 3. Renderiza os controles de pagina√ß√£o (APENAS se n√£o estiver pesquisando)
                if (!isSearching) {
                    renderPaginationControls(totalPages);
                } else {
                    document.getElementById('pagination-container').innerHTML = '';
                }

            } catch (error) {
                // Loga o erro, incluindo o erro de √≠ndice
                console.error("ERRO CR√çTICO NA CONSULTA DO FIRESTORE:", error);

                if (error.message && error.message.includes('requires an index')) {
                    // Tenta extrair a URL de cria√ß√£o do √≠ndice do erro do Firebase (se for fornecida)
                    const indexUrlMatch = error.message.match(/https:\/\/[^\s]+/);
                    const indexUrl = indexUrlMatch ? indexUrlMatch[0] : 'Nenhuma URL de √≠ndice encontrada. Crie o √≠ndice manualmente: status ASC, __name__ DESC';
                    projectListElement.innerHTML = `
                        <p class="text-red-400 font-bold">ERRO DE √çNDICE: O Firestore exige um √≠ndice composto espec√≠fico.</p>
                        <p class="text-gray-400 mt-2">Por favor, verifique no Console do Firebase e crie o √≠ndice com a ordem exata:</p>
                        <ul class="list-disc list-inside mt-2 ml-4 text-gray-300">
                            <li>Campo 1: <code>status</code> (Ascendente)</li>
                            <li>Campo 2: <code>__name__</code> (Descendente)</li>
                        </ul>
                        <p class="text-sm text-red-500 mt-4">Erro Bruto: ${error.message}</p>
                        <p class="text-xs text-blue-400 mt-2">URL de Cria√ß√£o (Copie e Cole no seu navegador): ${indexUrl}</p>
                    `;
                } else {
                     projectListElement.innerHTML = `<p class="text-red-400">Erro ao carregar lista de projetos: ${error.message}</p>`;
                }
            }
        }


        function renderPaginationControls(pages) {
            const container = document.getElementById('pagination-container');
            container.innerHTML = '';
            
            // +1 para incluir a P√°gina Inicial (que √© a primeira visualiza√ß√£o)
            const totalButtons = pages + 1; 

            // Mostra apenas se houver mais de 5 projetos ativos
            if (totalButtons > 1) { 
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'mt-8 flex justify-center flex-wrap gap-2';
                
                // i = 1 √© a P√°gina Inicial. i > 1 s√£o as p√°ginas numeradas.
                for (let i = 1; i <= totalButtons; i++) {
                    const pageButton = document.createElement('button');
                    const pageIndex = i;
                    
                    pageButton.textContent = (pageIndex === 1) ? 'P√°gina Inicial (5 Recentes)' : `P√°gina ${pageIndex - 1}`;
                    pageButton.onclick = () => loadProjects(pageIndex);
                    
                    const baseClasses = 'py-2 px-4 rounded-lg text-sm transition duration-300 whitespace-nowrap';
                    
                    if (pageIndex === currentPage) {
                        pageButton.className = `${baseClasses} bg-purple-600 text-white font-bold`;
                    } else {
                        pageButton.className = `${baseClasses} bg-gray-800 hover:bg-purple-500 text-gray-300`;
                    }
                    paginationDiv.appendChild(pageButton);
                }
                container.appendChild(paginationDiv);
            }
        }

        
        document.addEventListener('DOMContentLoaded', () => {
  const pass = document.getElementById('adminPassword');
  const email = document.getElementById('adminEmail');

  if (email) {
    email.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
  }

  if (pass) {
    pass.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
  }
});
    </script>
</body>
</html>
