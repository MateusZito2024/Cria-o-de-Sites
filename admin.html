<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asthro | Painel de Administra√ß√£o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@700&family=Manrope:wght@400;600;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://i.imgur.com/ZeaGXHD.png">

    <style>
        /* Tipografia Padronizada */
        h2, h3, h4 { font-family: 'Archivo', sans-serif; }
        body, p, a, input, button, select, textarea { font-family: 'Manrope', sans-serif; font-weight: 400; }
        
        body { background: #111111; color: #edf1f7; min-height: 100vh; }
        .gradient-text { background: linear-gradient(135deg, #6627ff, #0bf4ed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .neon-border { border: 1px solid rgba(102, 39, 255, 0.4); box-shadow: 0 0 10px rgba(11, 244, 237, 0.2); }
        /* Estilo para a caixa de di√°logo de confirma√ß√£o (substituindo o confirm() nativo) */
        .custom-dialog {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="p-8">

    <header class="text-center mb-12">
        <h1 class="text-4xl font-bold gradient-text" style="font-family: 'Archivo', sans-serif;">Painel de Administra√ß√£o</h1>
        <p class="text-lg mt-2">Gerenciamento de Status de Projetos Asthro</p>
    </header>

    <!-- Di√°logo de Confirma√ß√£o Customizado -->
    <div id="confirm-dialog" class="custom-dialog hidden">
        <div class="p-6 rounded-xl bg-gray-900 neon-border max-w-sm w-full">
            <h4 class="text-xl font-bold text-white mb-4">Confirma√ß√£o</h4>
            <p id="confirm-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Cancelar</button>
                <button id="confirm-ok" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Finalizar</button>
            </div>
        </div>
    </div>


    <div id="login-section" class="max-w-md mx-auto p-6 rounded-xl bg-gray-900 neon-border">
        <h3 class="text-2xl font-bold text-white mb-4">Acesso Restrito</h3>
        <input type="password" id="adminPassword" placeholder="Digite a Senha de Admin" class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500 mb-4">
        <button onclick="login()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 w-full">Entrar</button>
        <p id="login-feedback" class="mt-4 text-red-400 hidden">Senha incorreta.</p>
    </div>

    <div id="admin-panel" class="max-w-4xl mx-auto hidden">
        
        <div class="p-6 rounded-xl bg-gray-900 neon-border mb-8">
            <h3 class="text-2xl font-bold gradient-text mb-4" id="form-title">Criar Novo Projeto</h3>
            
            <label for="idInput" class="block text-sm font-medium text-gray-400 mt-4">ID do Projeto (ASTHRO-XXX)</label>
            <input type="text" id="idInput" placeholder="Ex: ASTHRO-001" class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500">

            <label for="clientNameInput" class="block text-sm font-medium text-gray-400 mt-4">Nome do Cliente / Projeto</label>
            <input type="text" id="clientNameInput" placeholder="Nome do Cliente" class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500">

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="statusSelect" class="block text-sm font-medium text-gray-400 mt-4">Status Atual</label>
                    <select id="statusSelect" class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500">
                        <option value="setup">Setup Inicial</option>
                        <option value="design_andamento">Design e Cria√ß√£o</option>
                        <option value="dev_andamento">Desenvolvimento</option>
                        <option value="revisao_cliente">Revis√£o do Cliente</option>
                    </select>
                </div>
                <div>
                    <label for="deliveryDateInput" class="block text-sm font-medium text-gray-400 mt-4">Previs√£o de Entrega</label>
                    <input type="date" id="deliveryDateInput" class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500">
                </div>
            </div>

            <label for="notesInput" class="block text-sm font-medium text-gray-400 mt-4">Notas do Consultor</label>
            <textarea id="notesInput" placeholder="Detalhes da etapa atual ou pr√≥ximos passos." class="w-full p-3 rounded-lg bg-gray-800 text-white border-gray-600 focus:ring-purple-500 focus:border-purple-500"></textarea>

            <div class="flex gap-4 mt-6">
                <!-- Alterado o onclick para openConfirmDialog() -->
                <button id="finishButton" onclick="openConfirmDialog()" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex-1">Finalizar Projeto</button>
                <button onclick="saveProject()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex-1">Salvar / Atualizar Projeto</button>
            </div>
            
            <p id="admin-feedback" class="mt-4 hidden"></p>
        </div>

        <h3 class="text-2xl font-bold gradient-text mb-4">Projetos Existentes</h3>
        <div id="project-list" class="space-y-4">
            <p class="text-gray-500">Carregando projetos...</p>
        </div>
        <!-- Controles de Pagina√ß√£o -->
        <div id="pagination-container"></div>
    </div>


    <script>
        // SUAS CREDENCIAIS DO FIREBASE
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBb8jAT-VR5723XaxZnH4jcw-PxOlRKn8w", 
            authDomain: "asthro-status-tracker.firebaseapp.com",
            projectId: "asthro-status-tracker",
            storageBucket: "asthro-status-tracker.firebasestorage.app",
            messagingSenderId: "1023071296327",
            appId: "1:1023071296327:web:477b39bd6d846fff148a62"
        };
        
        const ADMIN_PASSWORD = "Marmat0155"; // üëà DEFINA UMA SENHA AQUI PARA TESTE

        // Inicializa o Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Vari√°veis de Pagina√ß√£o
        const PROJECTS_PER_PAGE = 6;
        const HOME_PAGE_PROJECTS = 5;
        let currentPage = 1;
        let totalPages = 1;

        const projectListElement = document.getElementById('project-list');
        const adminFeedbackElement = document.getElementById('admin-feedback');
        
        // Mapeamento de Status
        const statusMap = {
            'setup': { name: 'Setup Inicial', percent: 10 },
            'design_andamento': { name: 'Design e Cria√ß√£o', percent: 35 },
            'dev_andamento': { name: 'Desenvolvimento em Andamento', percent: 65 },
            'revisao_cliente': { name: 'Revis√£o do Cliente', percent: 85 },
            'concluido': { name: 'CONCLU√çDO', percent: 100 }
        };

        function login() {
            const inputPassword = document.getElementById('adminPassword').value;
            const feedback = document.getElementById('login-feedback');

            if (inputPassword === ADMIN_PASSWORD && ADMIN_PASSWORD !== "SUA_SENHA_SECRETA_AQUI") {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                loadProjects();
            } else {
                feedback.textContent = "Senha incorreta ou senha padr√£o n√£o alterada.";
                feedback.classList.remove('hidden');
            }
        }
        
        function resetForm() {
            document.getElementById('form-title').textContent = 'Criar Novo Projeto';
            document.getElementById('idInput').value = '';
            document.getElementById('idInput').disabled = false;
            document.getElementById('clientNameInput').value = '';
            document.getElementById('statusSelect').value = 'setup';
            document.getElementById('deliveryDateInput').value = '';
            document.getElementById('notesInput').value = '';
            document.getElementById('finishButton').classList.add('hidden');
        }

        // Fun√ß√£o para mostrar o di√°logo de confirma√ß√£o (substitui confirm())
        function openConfirmDialog() {
            const projectId = document.getElementById('finishButton').getAttribute('data-project-id');
            const dialog = document.getElementById('confirm-dialog');
            document.getElementById('confirm-message').textContent = 
                `Tem certeza que deseja FINALIZAR e ARQUIVAR o projeto ${projectId}? O ID ficar√° dispon√≠vel para reutiliza√ß√£o.`;
            
            dialog.classList.remove('hidden');

            const handleFinish = () => {
                finishProject(projectId);
                dialog.classList.add('hidden');
                document.getElementById('confirm-ok').removeEventListener('click', handleFinish);
            };

            const handleCancel = () => {
                dialog.classList.add('hidden');
                document.getElementById('confirm-cancel').removeEventListener('click', handleCancel);
            };

            document.getElementById('confirm-ok').addEventListener('click', handleFinish);
            document.getElementById('confirm-cancel').addEventListener('click', handleCancel);
        }


        function editProject(projectId) {
            db.collection('projects').doc(projectId).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('form-title').textContent = `Editar Projeto: ${projectId}`;
                    document.getElementById('idInput').value = projectId;
                    document.getElementById('idInput').disabled = true; 
                    document.getElementById('clientNameInput').value = data.clientName || '';
                    document.getElementById('statusSelect').value = data.status === 'concluido' ? 'setup' : data.status || 'setup'; 
                    document.getElementById('deliveryDateInput').value = data.deliveryDate || '';
                    document.getElementById('notesInput').value = data.notes || '';
                    
                    // Exibe ou esconde o bot√£o Finalizar
                    const isConcluido = data.status === 'concluido';
                    const finishButton = document.getElementById('finishButton');
                    finishButton.classList.toggle('hidden', isConcluido);
                    finishButton.setAttribute('data-project-id', projectId);
                    window.scrollTo(0, 0); // Rola para o topo para ver o formul√°rio
                }
            }).catch(error => console.error("Erro ao buscar projeto para edi√ß√£o:", error));
        }

        async function finishProject(projectId) {
            try {
                // Atualiza o projeto para o status "concluido"
                await db.collection('projects').doc(projectId).update({
                    status: 'concluido',
                    notes: 'Projeto formalmente FINALIZADO e ENTREGUE.',
                    deliveryDate: new Date().toISOString().split('T')[0] // Data de hoje
                });
                
                adminFeedbackElement.textContent = `Projeto ${projectId} FINALIZADO com sucesso!`;
                adminFeedbackElement.className = 'mt-4 text-green-400';
                adminFeedbackElement.classList.remove('hidden');
                
                resetForm();
                loadProjects();
                
            } catch (error) {
                console.error("Erro ao finalizar projeto:", error);
                adminFeedbackElement.textContent = "Erro ao finalizar: Verifique as permiss√µes.";
                adminFeedbackElement.className = 'mt-4 text-red-400';
                adminFeedbackElement.classList.remove('hidden');
            }
        }


        async function saveProject() {
            const projectId = document.getElementById('idInput').value.trim().toUpperCase();
            const clientName = document.getElementById('clientNameInput').value.trim();
            const status = document.getElementById('statusSelect').value;
            const deliveryDate = document.getElementById('deliveryDateInput').value;
            const notes = document.getElementById('notesInput').value.trim();

            const isEditMode = document.getElementById('idInput').disabled;

            if (!projectId || !clientName || !status) {
                adminFeedbackElement.textContent = "Nome do Cliente e ID do Projeto s√£o obrigat√≥rios.";
                adminFeedbackElement.className = 'mt-4 text-red-400';
                adminFeedbackElement.classList.remove('hidden');
                return;
            }

            try {
                const docRef = db.collection('projects').doc(projectId);
                
                if (!isEditMode) {
                    // --- L√≥gica de Prote√ß√£o Contra Sobrescrita ---
                    const existingDoc = await docRef.get();
                    if (existingDoc.exists) {
                        const existingData = existingDoc.data();
                        
                        if (existingData.status !== 'concluido') {
                            adminFeedbackElement.textContent = `ERRO: J√° existe um projeto ATIVO (${existingData.clientName}, Status: ${statusMap[existingData.status].name}) com o ID ${projectId}. Finalize-o antes de reutilizar o ID.`;
                            adminFeedbackElement.className = 'mt-4 text-red-400';
                            adminFeedbackElement.classList.remove('hidden');
                            return; // BLOQUEIA A CRIA√á√ÉO
                        }
                        // Se o status for 'concluido', o ID pode ser reutilizado (sobrescrito).
                    }
                }
                
                // --- Salva ou Atualiza o Projeto ---
                await docRef.set({
                    clientName: clientName,
                    status: status, 
                    deliveryDate: deliveryDate,
                    notes: notes
                }, { merge: true });

                adminFeedbackElement.textContent = `Projeto ${projectId} salvo com sucesso!`;
                adminFeedbackElement.className = 'mt-4 text-green-400';
                adminFeedbackElement.classList.remove('hidden');

                resetForm();
                loadProjects();

            } catch (error) {
                console.error("Erro ao salvar projeto:", error);
                adminFeedbackElement.textContent = "Erro ao salvar: Verifique suas permiss√µes do Firestore.";
                adminFeedbackElement.className = 'mt-4 text-red-400';
                adminFeedbackElement.classList.remove('hidden');
            }
        }

        async function loadProjects(page = 1) {
            projectListElement.innerHTML = '';
            currentPage = page;
            document.getElementById('pagination-container').innerHTML = ''; 

            try {
                // Query base para todos os projetos ativos, ordenada por Status (Asc) e ID (Desc)
                // Esta query requer o √≠ndice composto: status ASC, __name__ DESC
                let baseQuery = db.collection('projects')
                                  .where('status', '!=', 'concluido') 
                                  .orderBy('status') 
                                  .orderBy(firebase.firestore.FieldPath.documentId(), 'desc');

                const countSnapshot = await baseQuery.get();
                const totalActiveProjects = countSnapshot.docs.length;

                // Calcula o total de p√°ginas (al√©m da Home Page)
                const projectsAfterHome = Math.max(0, totalActiveProjects - HOME_PAGE_PROJECTS);
                totalPages = Math.ceil(projectsAfterHome / PROJECTS_PER_PAGE);

                let query = baseQuery;
                
                // --- L√≥gica de Pagina√ß√£o ---

                if (currentPage === 1) {
                    // P√°gina Inicial: mostra os 5 mais recentes (ou menos, se n√£o houver 5)
                    query = baseQuery.limit(HOME_PAGE_PROJECTS);
                } else {
                    // P√°ginas subsequentes: pula os 5 da home + as p√°ginas anteriores
                    const docsToSkip = HOME_PAGE_PROJECTS + (currentPage - 2) * PROJECTS_PER_PAGE;
                    
                    if (docsToSkip > 0) {
                        // Busca o documento que √© o ponto de in√≠cio (o √∫ltimo documento da p√°gina anterior)
                        // A baseQuery √© usada aqui para garantir a mesma ordena√ß√£o e filtro
                        const startDocSnapshot = await baseQuery.limit(docsToSkip).get();
                        
                        if (!startDocSnapshot.empty) {
                            const startDoc = startDocSnapshot.docs[startDocSnapshot.docs.length - 1];
                            // A query final come√ßa AP√ìS o √∫ltimo documento pego e limita a 6
                            query = baseQuery.startAfter(startDoc).limit(PROJECTS_PER_PAGE);
                        } else {
                            // Este caso deve ser capturado pelo countSnapshot.empty, mas √© uma seguran√ßa.
                            projectListElement.innerHTML = '<p class="text-gray-500">Nenhum projeto encontrado nesta p√°gina.</p>';
                            return;
                        }
                    } else {
                        // Se docsToSkip for 0 ou menos, volta para a primeira p√°gina (seguran√ßa)
                         query = baseQuery.limit(HOME_PAGE_PROJECTS);
                    }
                }
                
                const snapshot = await query.get();

                if (snapshot.empty) {
                    projectListElement.innerHTML = `<p class="text-gray-500">${totalActiveProjects > 0 ? 'Nenhum projeto ativo nesta p√°gina.' : 'Nenhum projeto cadastrado ativo.'}</p>`;
                    renderPaginationControls(totalPages); 
                    return;
                }

                // 3. Renderiza os projetos
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const statusInfo = statusMap[data.status] || { name: 'Desconhecido', color: 'text-red-500' };

                    const projectCard = document.createElement('div');
                    projectCard.className = `p-4 bg-gray-800 rounded-lg flex justify-between items-center neon-border`;
                    projectCard.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold text-white">${data.clientName} (${doc.id})</p>
                            <p class="text-sm text-gray-400">Status: <span class="text-purple-400 font-bold">${statusInfo.name}</span></p>
                            <p class="text-sm text-gray-400">Entrega: ${data.deliveryDate || 'N/A'}</p>
                            <p class="text-xs text-gray-600 mt-1">ID: ${doc.id}</p>
                        </div>
                        <button onclick="editProject('${doc.id}')" class="bg-indigo-500 hover:bg-indigo-600 text-white py-1 px-3 rounded-md text-sm">Editar</button>
                    `;
                    projectListElement.appendChild(projectCard);
                });

                // 4. Renderiza os controles de pagina√ß√£o
                renderPaginationControls(totalPages);
                
            } catch (error) {
                // Loga o erro exato e a URL se for um erro de √≠ndice
                console.error("ERRO CR√çTICO NA CONSULTA DO FIRESTORE:", error);
                
                if (error.message && error.message.includes('requires an index')) {
                    // Tenta extrair a URL de cria√ß√£o do √≠ndice do erro do Firebase (se for fornecida)
                    const indexUrlMatch = error.message.match(/https:\/\/[^\s]+/);
                    const indexUrl = indexUrlMatch ? indexUrlMatch[0] : 'Nenhuma URL de √≠ndice encontrada. Crie o √≠ndice manualmente: status ASC, __name__ DESC';
                    
                    projectListElement.innerHTML = `
                        <p class="text-red-400 font-bold">ERRO DE √çNDICE: O Firestore exige um √≠ndice composto espec√≠fico.</p>
                        <p class="text-gray-400 mt-2">Por favor, verifique no Console do Firebase e crie o √≠ndice com a ordem exata:</p>
                        <ul class="list-disc list-inside mt-2 ml-4 text-gray-300">
                            <li>Campo 1: <code>status</code> (Ascendente)</li>
                            <li>Campo 2: <code>__name__</code> (Descendente)</li>
                        </ul>
                        <p class="text-sm text-red-500 mt-4">Erro Bruto: ${error.message}</p>
                        <p class="text-xs text-blue-400 mt-2">URL de Cria√ß√£o (Copie e Cole no seu navegador): ${indexUrl}</p>
                    `;
                } else {
                     projectListElement.innerHTML = `<p class="text-red-400">Erro ao carregar lista de projetos: ${error.message}</p>`;
                }
            }
        }


        function renderPaginationControls(pages) {
            const container = document.getElementById('pagination-container');
            container.innerHTML = '';
            
            // +1 para incluir a P√°gina Inicial (que √© a primeira visualiza√ß√£o)
            const totalButtons = pages + 1; 

            // Mostra apenas se houver mais de 5 projetos ativos
            if (totalButtons > 1) { 
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'mt-8 flex justify-center flex-wrap gap-2';
                
                // i = 1 √© a P√°gina Inicial. i > 1 s√£o as p√°ginas numeradas.
                for (let i = 1; i <= totalButtons; i++) {
                    const pageButton = document.createElement('button');
                    const pageIndex = i;
                    
                    pageButton.textContent = (pageIndex === 1) ? 'P√°gina Inicial (5 Recentes)' : `P√°gina ${pageIndex - 1}`;
                    pageButton.onclick = () => loadProjects(pageIndex);
                    
                    const baseClasses = 'py-2 px-4 rounded-lg text-sm transition duration-300 whitespace-nowrap';
                    
                    if (pageIndex === currentPage) {
                        pageButton.className = `${baseClasses} bg-purple-600 text-white font-bold`;
                    } else {
                        pageButton.className = `${baseClasses} bg-gray-800 hover:bg-purple-500 text-gray-300`;
                    }
                    paginationDiv.appendChild(pageButton);
                }
                container.appendChild(paginationDiv);
            }
        }

        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
