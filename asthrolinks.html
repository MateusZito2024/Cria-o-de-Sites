<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AsthroLinks | Fusion Studio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@900&family=Cinzel:wght@700&family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@500&family=Space+Grotesk:wght@700&family=VT323&family=Press+Start+2P&family=Playfair+Display:ital,wght@0,700;1,400&family=Outfit:wght@900&family=Permanent+Marker&family=UnifrakturMaguntia&family=Bangers&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- EDITOR UI (Baseado na versão Studio melhorada) --- */
    :root { --primary: #6627ff; --bg: #09090b; --panel: #121214; --border: #27272a; --text: #e4e4e7; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
    
    .app { display: grid; grid-template-columns: 450px 1fr; height: 100%; }
    .sidebar { background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; z-index: 10; }
    
    .header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #000; }
    .logo { font-family: 'Archivo', sans-serif; font-size: 20px; font-weight: 900; }
    .logo span { color: var(--primary); }

    .tabs { display: flex; border-bottom: 1px solid var(--border); background: #1a1a1a; }
    .tab-btn { flex: 1; padding: 15px; background: transparent; border: none; color: #888; font-weight: 600; font-size: 11px; cursor: pointer; border-bottom: 2px solid transparent; text-transform: uppercase; }
    .tab-btn.active { color: #fff; border-bottom-color: var(--primary); background: var(--panel); }

    .tab-content { display: none; flex: 1; overflow-y: auto; padding: 20px; }
    .tab-content.active { display: block; }
    .tab-content::-webkit-scrollbar { width: 6px; }
    .tab-content::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    .section-label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--primary); margin: 25px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }

    input, textarea, select { width: 100%; background: #18181b; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 6px; font-family: inherit; font-size: 13px; margin-bottom: 10px; }
    input:focus { border-color: var(--primary); outline: none; }

    .btn { width: 100%; padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 700; font-size: 12px; text-transform: uppercase; background: #27272a; color: #fff; transition: 0.2s; display:flex; justify-content:center; align-items:center; gap:8px; }
    .btn:hover { background: #3f3f46; }
    .btn-primary { background: var(--primary); }
    .btn-icon { width: auto; padding: 8px 12px; }

    /* Templates Grid */
    .grid-tpl { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
    .tpl-item { background: #000; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; }
    .tpl-item:hover { transform: translateY(-2px); border-color: #666; }
    .tpl-item.active { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); }
    .tpl-preview { height: 80px; width: 100%; background-size: cover; background-position: center; }
    .tpl-meta { padding: 8px; background: #161616; font-size: 10px; font-weight: 700; display: flex; justify-content: space-between; }

    /* Links */
    .link-row { background: #18181b; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 1px solid var(--border); }
    
    /* Design Controls */
    .color-row { display: flex; justify-content: space-between; align-items: center; background: #18181b; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
    input[type="color"] { width: 30px; height: 30px; padding: 0; border: none; background: none; cursor: pointer; margin: 0; }

    /* Preview */
    .preview-stage { background: #050505; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px; }
    .device { width: 380px; height: 750px; background: #000; border-radius: 45px; border: 10px solid #222; overflow: hidden; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.9); transition: 0.3s; }
    iframe { width: 100%; height: 100%; border: none; background: #fff; }

    /* Modal */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .overlay.visible { display: flex; }
    .modal { background: #121214; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; border: 1px solid #333; }

    @media (max-width: 900px) {
      .app { display: block; grid-template-columns: 1fr; overflow: auto; }
      .sidebar { min-height: auto; }
      .preview-stage { padding: 40px 20px; min-height: 100vh; }
      .device { height: 700px; width: 100%; }
    }
  </style>
</head>
<body>

  <div class="overlay visible" id="auth-screen">
    <div class="modal" style="text-align:center;">
      <h1 class="logo" style="font-size:32px; margin-bottom:10px;">Asthro<span>Links</span></h1>
      <p style="color:#666; font-size:14px; margin-bottom:25px;">Fusion Studio Edition</p>
      <button class="btn" style="background:#fff; color:#000;" id="btn-google"><i class="fab fa-google"></i> Entrar com Google</button>
    </div>
  </div>

  <div class="app" id="app-ui">
    <div class="sidebar">
      <div class="header">
        <div class="logo">Asthro<span>Links</span></div>
        <button class="btn btn-icon" style="background:#330000; color:#ff4444;" onclick="logout()"><i class="fas fa-power-off"></i></button>
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-content', this)">Conteúdo</button>
        <button class="tab-btn" onclick="switchTab('tab-design', this)">Aparência</button>
      </div>

      <div class="tab-content active" id="tab-content">
        <div class="section-label">Perfil</div>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <img id="edit-avatar" src="" style="width:50px; height:50px; border-radius:8px; object-fit:cover; background:#222; border:1px solid #333;">
          <div style="flex:1;">
             <input id="in-name" placeholder="Seu Nome">
             <input id="in-photo" placeholder="URL da Foto" style="font-size:11px; margin:0;">
          </div>
        </div>
        <textarea id="in-bio" placeholder="Bio..." rows="2"></textarea>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:10px;">
          <div class="section-label" style="margin:0;">Links</div>
          <button class="btn btn-primary btn-icon" style="font-size:10px;" onclick="openLinkModal()">+ ADICIONAR</button>
        </div>
        <div id="link-list"></div>

        <div style="margin-top:30px; padding:15px; background:rgba(102,39,255,0.1); border-radius:8px; border:1px dashed var(--primary);">
          <label style="margin:0 0 5px; color:var(--primary); font-size:10px; font-weight:bold;">LINK PÚBLICO</label>
          <div style="display:flex; gap:5px;">
            <input id="my-url" readonly style="background:transparent; border:none; padding:0; color:#fff; font-size:12px; margin:0;">
            <button class="btn btn-icon" onclick="copyUrl()"><i class="far fa-copy"></i></button>
            <a id="open-btn" class="btn btn-icon" target="_blank" style="text-decoration:none;">↗</a>
          </div>
        </div>
        <div style="height:50px;"></div>
      </div>

      <div class="tab-content" id="tab-design">
        <div class="section-label">Escolher Template (13)</div>
        <div class="grid-tpl" id="tpl-list"></div>

        <div class="section-label">Personalização (Studio)</div>
        <p style="font-size:11px; color:#666; margin-bottom:15px;">Estas opções sobrescrevem o estilo original do template.</p>
        
        <label style="font-size:10px; color:#888;">Fundo Personalizado</label>
        <select id="design-bg-mode">
          <option value="default">Usar do Template (Original)</option>
          <option value="color">Cor Sólida</option>
          <option value="image">Imagem</option>
          <option value="gradient">Degradê</option>
        </select>
        
        <div id="box-bg-color" style="display:none;">
           <div class="color-row"><span>Cor de Fundo</span> <input type="color" id="design-bg-color" value="#000000"></div>
        </div>
        <div id="box-bg-img" style="display:none;">
           <input id="design-bg-img" placeholder="URL da Imagem de Fundo">
        </div>

        <label style="font-size:10px; color:#888; margin-top:10px;">Tipografia Global</label>
        <select id="design-font">
          <option value="inherit">Usar do Template (Original)</option>
          <option value="'Inter', sans-serif">Inter (Clean)</option>
          <option value="'Playfair Display', serif">Playfair (Serif)</option>
          <option value="'JetBrains Mono', monospace">Mono (Code)</option>
          <option value="'Bangers', cursive">Bangers (Comic)</option>
          <option value="'Press Start 2P', cursive">Pixel (Retro)</option>
        </select>

        <div style="height:50px;"></div>
      </div>
    </div>

    <div class="preview-stage">
      <div class="device">
        <iframe id="preview-frame"></iframe>
      </div>
    </div>
  </div>

  <div class="overlay" id="link-modal">
    <div class="modal">
      <h3 style="color:#fff; margin-top:0;">Novo Link</h3>
      <input id="new-title" placeholder="Título (ex: Instagram)">
      <input id="new-url" placeholder="URL (https://...)">
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn" onclick="closeLinkModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="saveLink()">Salvar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBjwoUOoTSsdz3woXVSKd2uy3rmJ1A6YH4",
      authDomain: "asthrolinks.firebaseapp.com",
      projectId: "asthrolinks",
      storageBucket: "asthrolinks.firebasestorage.app",
      messagingSenderId: "628318025929",
      appId: "1:628318025929:web:9984c6630c77ab09947518"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userData = { 
      name:"", bio:"", photo:"", theme:"win95", links:[],
      // Configurações de Override (Opcionais)
      design: { bgMode: 'default', bgColor:'#000', bgImg:'', font:'inherit' }
    };
    let currentUser = null;

    // --- TEMPLATES ORIGINAIS (1-12) + MANGA (13) ---
    const TEMPLATES = [
      /* 1. WINDOWS 95 */
      {
        id: "win95", name: "Windows 95", tag: "Retro", preview: "background: #008080;",
        render: (d) => ({
          html: `<div class="desktop"><div class="icons-col"><div class="desktop-icon"><img src="https://win98icons.alexmeub.com/icons/png/computer_explorer-4.png"><span>My PC</span></div><div class="desktop-icon"><img src="https://win98icons.alexmeub.com/icons/png/network_neighborhood-4.png"><span>Network</span></div></div><div class="window"><div class="title-bar"><div class="title-bar-text">AsthroLinks.exe</div><div class="title-bar-controls"><button>X</button></div></div><div class="window-body"><div class="profile-box"><img src="${d.photo}"><div><p><strong>${d.name}</strong></p><p>${d.bio}</p></div></div><div class="divider"></div>${d.links.map(l => `<a href="${l.url}" target="_blank" class="win-btn"><img src="https://win98icons.alexmeub.com/icons/png/world-4.png"> ${l.title}</a>`).join('')}</div><div class="status-bar"><p class="status-bar-field">Total: ${d.links.length} objects</p></div></div><div class="taskbar"><button class="start-btn"><img src="https://win98icons.alexmeub.com/icons/png/windows-0.png"><b>Start</b></button><div class="time">4:20 PM</div></div></div>`,
          css: `body { background: #008080; font-family: 'VT323', monospace; height: 100vh; overflow: hidden; display: flex; flex-direction: column; } .desktop { flex: 1; padding: 10px; position: relative; display: flex; align-items: center; justify-content: center; } .icons-col { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 15px; } .desktop-icon { color: white; text-align: center; font-size: 14px; text-shadow: 1px 1px 0 #000; width: 60px; display: flex; flex-direction: column; align-items: center; } .desktop-icon img { width: 32px; margin-bottom: 2px; } .window { width: 100%; max-width: 400px; background: #c0c0c0; box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #fff, 2px 2px 5px rgba(0,0,0,0.5); padding: 3px; display: flex; flex-direction: column; } .title-bar { background: navy; padding: 3px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; } .title-bar-text { color: white; font-weight: bold; font-size: 16px; margin-left: 4px; } .title-bar-controls button { width: 16px; height: 14px; background: #c0c0c0; box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #fff; border: none; font-size: 10px; font-weight: bold; line-height: 10px; } .window-body { padding: 10px; flex: 1; overflow-y: auto; } .profile-box { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; } .profile-box img { width: 64px; height: 64px; border: 2px solid gray; object-fit: cover; background: #fff; } .profile-box p { margin: 0; font-size: 18px; color: #000; } .divider { border-top: 1px solid gray; border-bottom: 1px solid white; margin: 10px 0; } .win-btn { display: flex; align-items: center; gap: 8px; width: 100%; padding: 6px; margin-bottom: 6px; text-decoration: none; color: #000; border: 1px dotted transparent; font-size: 18px; } .win-btn:hover { background: navy; color: white; } .win-btn img { width: 24px; } .status-bar { border-top: 1px solid gray; padding: 2px; font-size: 14px; color: #444; } .taskbar { height: 28px; background: #c0c0c0; border-top: 2px solid #fff; display: flex; align-items: center; padding: 2px; } .start-btn { display: flex; align-items: center; gap: 4px; height: 22px; padding: 0 6px; box-shadow: inset -1px -1px #000, inset 1px 1px #fff; background: #c0c0c0; border: none; } .start-btn img { width: 16px; } .time { margin-left: auto; background: #c0c0c0; border: 2px solid gray; border-bottom-color: #fff; border-right-color: #fff; padding: 0 8px; font-size: 14px; }`
        })
      },
      /* 2. NEO POP */
      {
        id: "neopop", name: "Neo Pop", tag: "Brutalist", preview: "background: #fff000; border: 2px solid #000;",
        render: (d) => ({
          html: `<div class="neo-container"><div class="neo-header"><img src="${d.photo}"><h1>${d.name}</h1></div><div class="marquee"><p>${d.bio} • ${d.bio} •</p></div><div class="neo-stack">${d.links.map(l => `<a href="${l.url}" target="_blank" class="neo-link">${l.title}</a>`).join('')}</div><footer>ASTHRO LINKS</footer></div>`,
          css: `body { background: #a29bfe; font-family: 'Outfit', sans-serif; padding: 20px; min-height: 100vh; overflow-y: auto; } .neo-container { max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; } .neo-header { background: #fff; border: 4px solid #000; padding: 20px; box-shadow: 8px 8px 0 #000; border-radius: 15px; text-align: center; } .neo-header img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #000; object-fit: cover; margin-bottom: 10px; } h1 { margin: 0; font-weight: 900; text-transform: uppercase; font-size: 32px; line-height: 1; transform: rotate(-2deg); background: #ffeaa7; display: inline-block; padding: 0 10px; border: 2px solid #000; } .marquee { background: #000; color: #fff; overflow: hidden; white-space: nowrap; padding: 5px 0; border: 2px solid #000; font-weight: 700; font-size: 14px; transform: rotate(1deg); } .neo-link { display: block; background: #55efc4; border: 4px solid #000; padding: 15px; text-decoration: none; color: #000; font-weight: 900; font-size: 20px; text-transform: uppercase; text-align: center; box-shadow: 6px 6px 0 #000; transition: 0.2s; border-radius: 10px; } .neo-link:nth-child(even) { background: #ff7675; transform: rotate(1deg); } .neo-link:nth-child(odd) { background: #74b9ff; transform: rotate(-1deg); } .neo-link:hover { transform: translate(4px, 4px); box-shadow: 2px 2px 0 #000; } footer { text-align: center; font-weight: 900; margin-top: 20px; font-size: 12px; }`
        })
      },
      /* 3. iOS 17 */
      {
        id: "ios17", name: "iOS Widget", tag: "Mobile", preview: "background: linear-gradient(180deg, #6dd5fa, #2980b9);",
        render: (d) => ({
          html: `<div class="ios-screen"><div class="ios-time">12:45</div><div class="ios-date">Wednesday, January 28</div><div class="ios-widget-row"><div class="ios-widget sm"><img src="${d.photo}"></div><div class="ios-widget lg"><span>${d.name}</span><small>${d.bio}</small></div></div><div class="ios-notif-stack"><div class="notif-label">Notification Center</div>${d.links.map(l => `<a href="${l.url}" target="_blank" class="ios-notif"><div class="app-icon"></div><div class="notif-content"><div class="notif-title">Link</div><div class="notif-msg">${l.title}</div></div></a>`).join('')}</div><div class="home-bar"></div></div>`,
          css: `body { background: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1000&auto=format&fit=crop'); background-size: cover; background-position: center; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; overflow: hidden; color: #fff; } .ios-screen { height: 100%; backdrop-filter: brightness(0.9); padding: 50px 20px 20px; display: flex; flex-direction: column; align-items: center; } .ios-time { font-size: 68px; font-weight: 600; line-height: 1; letter-spacing: -2px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); } .ios-date { font-size: 18px; font-weight: 500; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); opacity: 0.9; } .ios-widget-row { display: flex; gap: 10px; width: 100%; margin-bottom: 30px; } .ios-widget { background: rgba(255,255,255,0.25); backdrop-filter: blur(20px); border-radius: 20px; padding: 15px; border: 1px solid rgba(255,255,255,0.3); } .ios-widget.sm { width: 80px; height: 80px; padding: 0; overflow: hidden; } .ios-widget.sm img { width: 100%; height: 100%; object-fit: cover; } .ios-widget.lg { flex: 1; height: 80px; display: flex; flex-direction: column; justify-content: center; } .ios-widget.lg span { font-weight: 700; font-size: 18px; } .ios-widget.lg small { font-size: 12px; opacity: 0.8; } .ios-notif-stack { width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; } .notif-label { font-size: 12px; opacity: 0.6; margin-bottom: 5px; margin-left: 5px; } .ios-notif { background: rgba(255,255,255,0.65); backdrop-filter: blur(25px); border-radius: 18px; padding: 12px; display: flex; gap: 12px; align-items: center; text-decoration: none; color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: 0.2s; } .ios-notif:hover { transform: scale(1.02); background: rgba(255,255,255,0.8); } .app-icon { width: 35px; height: 35px; background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); border-radius: 8px; } .notif-content { flex: 1; } .notif-title { font-size: 11px; font-weight: 600; opacity: 0.6; display: flex; justify-content: space-between; } .notif-msg { font-size: 15px; font-weight: 500; margin-top: 2px; } .home-bar { width: 120px; height: 5px; background: #fff; border-radius: 10px; margin-top: auto; opacity: 0.8; }`
        })
      },
      /* 4. GAMEBOY */
      {
        id: "gameboy", name: "GameBoy", tag: "8-bit", preview: "background: #bbb; border: 1px solid #888;",
        render: (d) => ({
          html: `<div class="gb-case"><div class="gb-screen-bezel"><div class="power-led"></div><div class="gb-screen"><div class="pixel-art"><img src="${d.photo}"><h3>${d.name}</h3><div class="menu-list">${d.links.map(l => `<a href="${l.url}" target="_blank">> ${l.title}</a>`).join('')}</div></div></div><div class="brand">NINTENDO</div></div><div class="controls"><div class="dpad"><div class="ud"></div><div class="lr"></div></div><div class="ab-btns"><div class="btn-round">A</div><div class="btn-round">B</div></div></div><div class="start-select"><div class="pill">SELECT</div><div class="pill">START</div></div></div>`,
          css: `body { background: #222; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: 'Press Start 2P', cursive; } .gb-case { width: 340px; height: 600px; background: #c0c0c0; border-radius: 15px 15px 40px 15px; padding: 20px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2), 0 0 50px rgba(0,0,0,0.5); position: relative; border: 2px solid #999; } .gb-screen-bezel { background: #555; border-radius: 10px 10px 30px 10px; padding: 30px 30px 10px 30px; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); position: relative; } .power-led { position: absolute; top: 10px; left: 10px; width: 8px; height: 8px; background: red; border-radius: 50%; box-shadow: 0 0 5px red; opacity: 0.8; } .gb-screen { background: #8bac0f; width: 100%; height: 220px; border: 2px solid #444; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); overflow-y: auto; padding: 10px; color: #0f380f; } .pixel-art { text-align: center; } .pixel-art img { width: 60px; height: 60px; object-fit: cover; border: 2px solid #0f380f; margin-bottom: 5px; filter: grayscale(100%) contrast(1.5); } h3 { font-size: 12px; margin: 0 0 15px 0; text-transform: uppercase; } .menu-list { display: flex; flex-direction: column; gap: 8px; text-align: left; } .menu-list a { text-decoration: none; color: #0f380f; font-size: 10px; padding: 5px; border: 1px dashed transparent; display: block; } .menu-list a:hover { background: #0f380f; color: #8bac0f; } .brand { color: #888; font-family: sans-serif; font-style: italic; font-weight: bold; margin-top: 5px; font-size: 10px; letter-spacing: 1px; } .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding: 0 10px; } .dpad { width: 90px; height: 90px; position: relative; } .ud { width: 30px; height: 90px; background: #333; position: absolute; left: 30px; border-radius: 3px; box-shadow: 2px 2px 0 #111; } .lr { width: 90px; height: 30px; background: #333; position: absolute; top: 30px; border-radius: 3px; box-shadow: 2px 2px 0 #111; } .ab-btns { display: flex; gap: 15px; transform: rotate(-25deg); margin-top: 10px; } .btn-round { width: 35px; height: 35px; background: #8b1d3d; border-radius: 50%; color: #c0c0c0; font-family: sans-serif; font-size: 10px; font-weight: bold; display: flex; justify-content: center; align-items: center; margin-bottom: -15px; box-shadow: 2px 2px 0 #441020; cursor: pointer; } .start-select { display: flex; justify-content: center; gap: 15px; margin-top: 30px; } .pill { width: 50px; height: 12px; background: #999; border-radius: 10px; transform: rotate(-25deg); border: 1px solid #777; font-family: sans-serif; font-size: 8px; text-align: center; line-height: 25px; color: #555; font-weight: bold; }`
        })
      },
      /* 5. STREAMING */
      {
        id: "streaming", name: "Streaming", tag: "App", preview: "background: #121212; border: 1px solid #333;",
        render: (d) => ({
          html: `<div class="app-ui"><div class="album-art"><img src="${d.photo}"></div><div class="song-info"><h1>${d.name}</h1><p>Verified Artist • ${d.bio}</p></div><div class="actions"><button class="play-btn">SHUFFLE PLAY</button><div class="icon-heart">♥</div></div><div class="playlist"><h3>Popular Links</h3>${d.links.map((l, i) => `<a href="${l.url}" target="_blank" class="track"><div class="track-num">${i+1}</div><div class="track-name">${l.title}</div><div class="track-opts">•••</div></a>`).join('')}</div></div>`,
          css: `body { background: #121212; color: #fff; font-family: 'Circular', Helvetica, Arial, sans-serif; height: 100vh; overflow-y: auto; padding-bottom: 20px; } .app-ui { padding: 20px; max-width: 500px; margin: 0 auto; background: linear-gradient(180deg, #404040 0%, #121212 40%); min-height: 100vh; } .album-art { text-align: center; margin-top: 20px; margin-bottom: 20px; } .album-art img { width: 200px; height: 200px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: cover; } .song-info { text-align: center; } h1 { font-size: 28px; font-weight: 900; margin: 0 0 5px 0; } p { color: #b3b3b3; font-size: 12px; margin: 0; text-transform: uppercase; letter-spacing: 1px; } .actions { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0 30px; } .play-btn { background: #1db954; color: #fff; border: none; padding: 12px 30px; border-radius: 30px; font-weight: bold; letter-spacing: 1px; font-size: 12px; cursor: pointer; } .play-btn:hover { transform: scale(1.05); background: #1ed760; } .icon-heart { font-size: 24px; color: #1db954; } .playlist h3 { font-size: 18px; margin-bottom: 15px; } .track { display: flex; align-items: center; padding: 12px 0; text-decoration: none; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); transition: 0.2s; } .track:hover { background: rgba(255,255,255,0.1); padding-left: 10px; border-radius: 5px; border-bottom: 1px solid transparent; } .track-num { color: #b3b3b3; font-size: 14px; width: 30px; text-align: center; } .track-name { flex: 1; font-weight: 500; font-size: 15px; } .track-opts { color: #b3b3b3; margin-right: 10px; }`
        })
      },
      /* 6. TERMINAL */
      {
        id: "terminal", name: "Hacker Terminal", tag: "Code", preview: "background: #000; border: 1px solid #0f0;",
        render: (d) => ({
          html: `<div class="screen"><div class="overlay-lines"></div><div class="term-text"><p>> INITIATING CONNECTION...</p><p>> IDENTITY VERIFIED: <span class="highlight">${d.name}</span></p><p>> BIO_DATA: "${d.bio}"</p><p>> LOADING MODULES...</p><br><div class="link-grid">${d.links.map(l => `<a href="${l.url}" target="_blank" class="cmd-link">[EXECUTE] ${l.title}</a>`).join('')}</div><br><p class="blink">> _</p></div></div>`,
          css: `body { background: #000; color: #0f0; font-family: 'JetBrains Mono', monospace; height: 100vh; overflow: hidden; } .screen { padding: 40px; height: 100%; position: relative; } .overlay-lines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%); background-size: 100% 4px; pointer-events: none; z-index: 2; } .term-text { position: relative; z-index: 1; text-shadow: 0 0 5px #0f0; } p { margin: 5px 0; font-size: 14px; } .highlight { color: #fff; font-weight: bold; } .link-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; } .cmd-link { display: block; color: #0f0; text-decoration: none; padding: 10px; border: 1px solid #0f0; transition: 0.1s; background: rgba(0, 255, 0, 0.05); } .cmd-link:hover { background: #0f0; color: #000; font-weight: bold; cursor: crosshair; } .blink { animation: blink 1s infinite; } @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }`
        })
      },
      /* 7. Y2K */
      {
        id: "y2k", name: "Y2K Chrome", tag: "2000s", preview: "background: linear-gradient(135deg, #ccc, #fff);",
        render: (d) => ({
          html: `<div class="y2k-bg"><div class="chrome-container"><div class="star-deco top-right">✦</div><img src="${d.photo}" class="y2k-avatar"><h1 class="chrome-text">${d.name}</h1><div class="bio-pill">${d.bio}</div><div class="orbit-links">${d.links.map(l => `<a href="${l.url}" target="_blank" class="pill-btn">${l.title}</a>`).join('')}</div><div class="star-deco bottom-left">✦</div></div></div>`,
          css: `body { background: #000; font-family: 'Space Grotesk', sans-serif; overflow: hidden; height: 100vh; } .y2k-bg { width: 100%; height: 100%; background: radial-gradient(circle at center, #222 0%, #000 100%); display: flex; align-items: center; justify-content: center; } .chrome-container { text-align: center; position: relative; width: 100%; max-width: 400px; padding: 20px; } .y2k-avatar { width: 120px; height: 120px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); object-fit: cover; filter: contrast(1.2); } .chrome-text { font-size: 36px; font-weight: 900; text-transform: uppercase; font-style: italic; margin: 10px 0; background: linear-gradient(to bottom, #fff 0%, #aaa 50%, #555 51%, #fff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); } .bio-pill { border: 1px solid #fff; color: #fff; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 12px; margin-bottom: 30px; backdrop-filter: blur(5px); } .orbit-links { display: flex; flex-direction: column; gap: 15px; } .pill-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 15px; border-radius: 50px; color: #fff; text-decoration: none; font-weight: bold; letter-spacing: 1px; transition: 0.3s; position: relative; overflow: hidden; } .pill-btn:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; } .star-deco { position: absolute; color: #fff; font-size: 40px; animation: spin 4s infinite linear; } .top-right { top: 0; right: 20px; } .bottom-left { bottom: 0; left: 20px; } @keyframes spin { 100% { transform: rotate(360deg); } }`
        })
      },
      /* 8. NEWSPAPER */
      {
        id: "newspaper", name: "Daily News", tag: "Serif", preview: "background: #f4f1ea; border: 1px solid #333;",
        render: (d) => ({
          html: `<div class="paper"><div class="news-header">THE DAILY LINK</div><div class="news-date">VOL. 1 • ${new Date().toDateString()} • PRICE: FREE</div><hr class="double"><div class="headline">${d.name} Launches New Page</div><div class="main-article"><img src="${d.photo}" class="news-img"><p class="lead">${d.bio}</p></div><hr><div class="classifieds"><h3>SEE MORE</h3>${d.links.map(l => `<a href="${l.url}" target="_blank" class="news-link">➤ ${l.title}</a>`).join('')}</div><div class="footer-news">Printed by AsthroLinks Press</div></div>`,
          css: `body { background: #eaddcf; color: #1a1a1a; font-family: 'Playfair Display', serif; padding: 20px; min-height: 100vh; } .paper { max-width: 500px; margin: 0 auto; background: #f4f1ea; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #d4d1ca; } .news-header { text-align: center; font-family: 'UnifrakturMaguntia', cursive; font-size: 48px; border-bottom: 3px solid #000; padding-bottom: 10px; line-height: 1; } .news-date { text-align: center; font-family: 'Inter', sans-serif; font-size: 10px; text-transform: uppercase; padding: 5px 0; border-bottom: 1px solid #000; } .double { border-top: 3px double #000; margin: 2px 0 20px; } .headline { font-size: 32px; font-weight: 900; line-height: 1; margin-bottom: 15px; text-align: left; } .main-article { display: flex; gap: 15px; align-items: flex-start; margin-bottom: 20px; } .news-img { width: 100px; height: 100px; object-fit: cover; filter: grayscale(100%) contrast(1.2); border: 1px solid #000; } .lead { font-family: 'Inter', serif; font-size: 12px; margin: 0; line-height: 1.5; text-align: justify; } hr { border: 0; border-top: 1px solid #000; margin: 20px 0; } .classifieds h3 { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 900; text-decoration: underline; margin-bottom: 10px; } .news-link { display: block; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 16px; text-decoration: none; color: #000; padding: 10px 0; border-bottom: 1px dotted #999; transition: 0.2s; } .news-link:hover { background: #eee; padding-left: 5px; } .footer-news { text-align: center; font-size: 10px; font-family: 'Inter', sans-serif; margin-top: 20px; opacity: 0.6; }`
        })
      },
      /* 9. POLAROID */
      {
        id: "polaroid", name: "Memories", tag: "Cozy", preview: "background: #5d4037;",
        render: (d) => ({
          html: `<div class="wood-table"><div class="photo-card"><div class="tape"></div><div class="img-frame"><img src="${d.photo}"></div><div class="marker-text">${d.name}</div></div><div class="paper-note"><p>${d.bio}</p></div><div class="stickers-area">${d.links.map(l => `<a href="${l.url}" target="_blank" class="sticker-link">${l.title}</a>`).join('')}</div></div>`,
          css: `body { background: #5d4037; font-family: 'Permanent Marker', cursive; overflow-x: hidden; height: 100vh; background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png'); } .wood-table { max-width: 500px; margin: 0 auto; padding: 40px 20px; display: flex; flex-direction: column; align-items: center; gap: 30px; } .photo-card { background: #fff; padding: 15px 15px 40px 15px; width: 220px; transform: rotate(-3deg); box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; } .tape { position: absolute; top: -15px; left: 35%; width: 60px; height: 25px; background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.2); transform: rotate(2deg); backdrop-filter: blur(2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); } .img-frame img { width: 100%; height: 180px; object-fit: cover; filter: sepia(0.2); border: 1px solid #eee; } .marker-text { text-align: center; font-size: 24px; color: #333; margin-top: 15px; } .paper-note { background: #f1f8e9; padding: 15px; width: 200px; box-shadow: 0 5px 10px rgba(0,0,0,0.2); transform: rotate(2deg); font-family: 'Inter', sans-serif; font-size: 12px; color: #555; position: relative; } .paper-note:before { content: ''; position: absolute; top: -10px; right: 20%; width: 40px; height: 20px; background: #e57373; opacity: 0.8; transform: rotate(-5deg); } .stickers-area { display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center; } .sticker-link { background: #fff9c4; color: #333; text-decoration: none; font-size: 18px; padding: 10px 20px; border-radius: 2px; box-shadow: 0 4px 5px rgba(0,0,0,0.2); transition: 0.2s; width: 80%; text-align: center; } .sticker-link:nth-child(even) { transform: rotate(1deg); background: #b3e5fc; } .sticker-link:nth-child(odd) { transform: rotate(-1deg); background: #ffccbc; } .sticker-link:hover { transform: scale(1.1) rotate(0deg); z-index: 10; }`
        })
      },
      /* 10. GLASS OS (Original) */
      {
        id: "glass", name: "Glass OS", tag: "3D", preview: "background: linear-gradient(135deg, #ddd, #fff);",
        render: (d) => ({
          html: `<div class="spatial-bg"><div class="glass-panel"><img src="${d.photo}" class="glass-avatar"><h2>${d.name}</h2><p>${d.bio}</p></div><div class="glass-dock">${d.links.map(l => `<a href="${l.url}" target="_blank" class="glass-icon"><span>${l.title.substring(0,2)}</span></a>`).join('')}</div><div class="glass-list">${d.links.map(l => `<a href="${l.url}" target="_blank" class="glass-row">${l.title} <span>→</span></a>`).join('')}</div></div>`,
          css: `body { background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000&auto=format&fit=crop'); background-size: cover; height: 100vh; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; } .spatial-bg { width: 100%; height: 100%; backdrop-filter: blur(10px); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; } .glass-panel { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 30px; padding: 40px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); width: 100%; max-width: 400px; margin-bottom: 20px; color: #fff; } .glass-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid rgba(255,255,255,0.5); } h2 { margin: 0; font-weight: 600; font-size: 24px; text-shadow: 0 2px 5px rgba(0,0,0,0.2); } p { opacity: 0.9; font-size: 14px; margin-top: 5px; } .glass-dock { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(200,200,200,0.2); padding: 10px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); } .glass-icon { width: 45px; height: 45px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; color: #fff; font-weight: bold; font-size: 12px; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); } .glass-icon:hover { background: rgba(255,255,255,0.5); transform: translateY(-5px); } .glass-list { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 10px; } .glass-row { display: flex; justify-content: space-between; padding: 15px 25px; background: rgba(255,255,255,0.15); border-radius: 15px; text-decoration: none; color: #fff; font-weight: 500; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; backdrop-filter: blur(20px); } .glass-row:hover { background: rgba(255,255,255,0.3); transform: scale(1.02); }`
        })
      },
      /* 11. HUD */
      {
        id: "hud", name: "Sci-Fi HUD", tag: "Robot", preview: "background: #000; border: 1px solid cyan;",
        render: (d) => ({
          html: `<div class="hud-layer"><div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div><div class="hud-content"><div class="scan-bar"></div><div class="hud-header"><div class="circle-profile"><img src="${d.photo}"></div><div class="hud-data"><div class="label">TARGET ID</div><div class="val">${d.name}</div><div class="label">STATUS</div><div class="val active">ONLINE</div></div></div><div class="link-modules">${d.links.map(l => `<a href="${l.url}" target="_blank" class="hud-btn"><span class="tiny">>></span> ${l.title}</a>`).join('')}</div></div></div>`,
          css: `body { background: #020202; color: #0ff; font-family: 'Orbitron', sans-serif; height: 100vh; overflow: hidden; } .hud-layer { height: 100%; border: 2px solid rgba(0,255,255,0.1); margin: 10px; position: relative; padding: 20px; background: radial-gradient(circle, rgba(0,255,255,0.05) 0%, rgba(0,0,0,1) 90%); } .corner { position: absolute; width: 20px; height: 20px; border: 2px solid #0ff; } .tl { top: -2px; left: -2px; border-right: none; border-bottom: none; } .tr { top: -2px; right: -2px; border-left: none; border-bottom: none; } .bl { bottom: -2px; left: -2px; border-right: none; border-top: none; } .br { bottom: -2px; right: -2px; border-left: none; border-top: none; } .scan-bar { height: 2px; width: 100%; background: rgba(0,255,255,0.5); animation: scan 3s infinite linear; position: absolute; top:0; left:0; opacity: 0.3; } @keyframes scan { 0% { top: 0; } 100% { top: 100%; } } .hud-header { display: flex; gap: 20px; align-items: center; border-bottom: 1px solid rgba(0,255,255,0.3); padding-bottom: 20px; margin-bottom: 20px; } .circle-profile img { width: 80px; height: 80px; border-radius: 50%; border: 2px dashed #0ff; padding: 3px; filter: drop-shadow(0 0 5px #0ff); } .label { font-size: 10px; opacity: 0.7; letter-spacing: 2px; margin-bottom: 2px; } .val { font-size: 18px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; } .val.active { color: #0f0; } .link-modules { display: flex; flex-direction: column; gap: 10px; } .hud-btn { display: block; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.3); padding: 15px; color: #0ff; text-decoration: none; font-size: 14px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); transition: 0.2s; } .hud-btn:hover { background: rgba(0,255,255,0.2); letter-spacing: 1px; } .tiny { font-size: 10px; margin-right: 5px; }`
        })
      },
      /* 12. VHS */
      {
        id: "vhs", name: "VHS Tape", tag: "Horror", preview: "background: #111; border: 1px solid #444;",
        render: (d) => ({
          html: `<div class="tv-screen"><div class="tracking-line"></div><div class="vhs-overlay">PLAY > 0:00:24</div><div class="content"><img src="${d.photo}" class="grainy-img"><h1 class="bleeding-text">${d.name}</h1><div class="links-vhs">${d.links.map(l => `<a href="${l.url}" target="_blank">${l.title}</a>`).join('')}</div></div></div>`,
          css: `body { background: #050505; color: #ddd; font-family: 'Courier New', monospace; height: 100vh; overflow: hidden; } .tv-screen { height: 100%; position: relative; padding: 20px; display: flex; align-items: center; justify-content: center; } .tracking-line { position: fixed; width: 100%; height: 5px; background: rgba(255,255,255,0.1); top: 10%; animation: track 4s infinite linear; z-index: 10; pointer-events: none; } @keyframes track { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } } .vhs-overlay { position: absolute; top: 30px; left: 30px; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000; z-index: 5; } .content { text-align: center; width: 100%; max-width: 400px; filter: contrast(1.2) brightness(0.9); } .grainy-img { width: 150px; height: 150px; object-fit: cover; filter: grayscale(100%) sepia(50%) hue-rotate(180deg); margin-bottom: 20px; border: 2px solid #fff; } .bleeding-text { font-size: 36px; text-transform: uppercase; color: #fff; text-shadow: -2px 0 red, 2px 0 blue; animation: shake 0.5s infinite; } @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } } .links-vhs { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; } .links-vhs a { color: #fff; font-size: 20px; text-decoration: none; border: 1px solid #fff; padding: 10px; text-transform: uppercase; transition: 0.2s; } .links-vhs a:hover { background: #fff; color: #000; text-shadow: none; }`
        })
      },
      /* 13. MANGA JJK (NOVO) */
      {
        id: "manga", name: "JJK Manga", tag: "Anime",
        preview: "background: radial-gradient(circle, #fff 20%, #000 20%); background-size: 10px 10px;",
        render: (d) => ({
          html: `<div class="manga-panel"><div class="speech-bubble">${d.bio}</div><img src="${d.photo}" class="char-img"><h1 class="shonen-title">${d.name}</h1><div class="action-lines"></div><div class="panel-links">${d.links.map(l => `<a href="${l.url}" target="_blank" class="manga-btn">${l.title}!!</a>`).join('')}</div></div>`,
          css: `body { background: #fff; background-image: radial-gradient(#000 15%, transparent 16%), radial-gradient(#000 15%, transparent 16%); background-size: 10px 10px; background-position: 0 0, 5px 5px; color: #000; font-family: 'Bangers', cursive; min-height: 100vh; overflow-x: hidden; } .manga-panel { padding: 20px; max-width: 500px; margin: 0 auto; position: relative; } .char-img { width: 150px; height: 150px; object-fit: cover; border: 4px solid #000; box-shadow: 10px 10px 0 #000; display: block; margin: 20px auto; filter: contrast(1.2) grayscale(100%); } .shonen-title { font-size: 48px; text-align: center; text-transform: uppercase; -webkit-text-stroke: 2px #fff; text-shadow: 4px 4px 0 #ff0055; transform: rotate(-2deg); margin: 10px 0 30px; letter-spacing: 2px; } .speech-bubble { background: #fff; border: 3px solid #000; padding: 15px; border-radius: 50%; text-align: center; font-family: 'Inter', sans-serif; font-weight: bold; position: relative; max-width: 200px; margin: 0 auto; font-size: 12px; } .speech-bubble:after { content:''; position: absolute; bottom: -10px; left: 50%; width: 20px; height: 20px; background: #fff; border-bottom: 3px solid #000; border-right: 3px solid #000; transform: rotate(45deg); } .panel-links { display: flex; flex-direction: column; gap: 15px; position: relative; z-index: 2; } .manga-btn { background: #fff; color: #000; border: 4px solid #000; padding: 15px; font-size: 22px; text-decoration: none; text-transform: uppercase; text-align: center; font-weight: bold; box-shadow: 5px 5px 0 #000; transition: 0.1s; clip-path: polygon(2% 0, 100% 0, 98% 100%, 0% 100%); } .manga-btn:hover { background: #ff0055; color: #fff; transform: scale(1.05) rotate(1deg); box-shadow: 8px 8px 0 #000; } .action-lines { position: fixed; inset: 0; background: repeating-linear-gradient(90deg, transparent 0, transparent 40px, rgba(0,0,0,0.1) 40px, rgba(0,0,0,0.1) 42px); pointer-events: none; z-index: 0; }`
        })
      }
    ];

    // --- LOGICA DE RENDERIZAÇÃO HÍBRIDA ---
    const updatePreview = () => {
      const t = TEMPLATES.find(x => x.id === userData.theme) || TEMPLATES[0];
      const templateOutput = t.render(userData);
      
      // Override CSS System (Aplica alterações do Studio APENAS se o usuário mudar o padrão)
      let customCSS = '';
      const d = userData.design || {};

      // Background Override
      if (d.bgMode === 'color' && d.bgColor) customCSS += `body { background: ${d.bgColor} !important; background-image: none !important; } `;
      if (d.bgMode === 'image' && d.bgImg) customCSS += `body { background: url('${d.bgImg}') center/cover no-repeat fixed !important; } `;
      if (d.bgMode === 'gradient') customCSS += `body { background: linear-gradient(135deg, #6627ff, #ff0055) !important; background-image: none !important; } `;

      // Font Override
      if (d.font && d.font !== 'inherit') customCSS += `body, h1, h2, h3, a, p { font-family: ${d.font} !important; } `;

      const fullHTML = `
        <!DOCTYPE html><html><head>
        <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@900&family=Cinzel:wght@700&family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@500&family=Space+Grotesk:wght@700&family=VT323&family=Press+Start+2P&family=Playfair+Display:ital,wght@0,700;1,400&family=Outfit:wght@900&family=Permanent+Marker&family=UnifrakturMaguntia&family=Bangers&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
        <style>${templateOutput.css} ${customCSS}</style>
        </head><body>${templateOutput.html}</body></html>`;
      
      document.getElementById('preview-frame').srcdoc = fullHTML;
    };

    const renderUI = () => {
      document.getElementById('in-name').value = userData.name || '';
      document.getElementById('in-bio').value = userData.bio || '';
      document.getElementById('in-photo').value = userData.photo || '';
      document.getElementById('edit-avatar').src = userData.photo || '';

      // Design Inputs
      if(userData.design) {
        document.getElementById('design-bg-mode').value = userData.design.bgMode || 'default';
        document.getElementById('design-bg-color').value = userData.design.bgColor || '#000000';
        document.getElementById('design-bg-img').value = userData.design.bgImg || '';
        document.getElementById('design-font').value = userData.design.font || 'inherit';
        
        // Show/Hide Helpers
        document.getElementById('box-bg-color').style.display = userData.design.bgMode === 'color' ? 'block' : 'none';
        document.getElementById('box-bg-img').style.display = userData.design.bgMode === 'image' ? 'block' : 'none';
      }

      document.getElementById('tpl-list').innerHTML = TEMPLATES.map(t => `
        <div class="tpl-item ${userData.theme === t.id ? 'active' : ''}" onclick="window.setTheme('${t.id}')">
          <div class="tpl-preview" style="${t.preview}"></div>
          <div class="tpl-meta"><span>${t.name}</span><span style="opacity:0.6">${t.tag}</span></div>
        </div>
      `).join('');

      document.getElementById('link-list').innerHTML = userData.links.map((l, i) => `
        <div class="link-row">
          <div style="font-size:12px; font-weight:600;">${l.title}</div>
          <button class="btn btn-icon btn-danger" onclick="window.deleteLink(${i})">✕</button>
        </div>
      `).join('');

      updatePreview();
    };

    // --- ACTIONS ---
    window.setTheme = (id) => updateDB({ theme: id });
    
    // Auto-save & Update Logic
    const updateDB = async (changes) => {
      Object.assign(userData, changes);
      if(changes.design) Object.assign(userData.design, changes.design);
      renderUI();
      if(currentUser) await updateDoc(doc(db, "users", currentUser.uid), userData);
    };

    // Listeners
    ['in-name', 'in-bio', 'in-photo'].forEach(id => {
      document.getElementById(id).addEventListener('input', (e) => {
        updateDB({ [id.replace('in-', '')]: e.target.value });
      });
    });

    // Design Listeners
    document.getElementById('design-bg-mode').addEventListener('change', (e) => updateDB({ design: { ...userData.design, bgMode: e.target.value } }));
    document.getElementById('design-bg-color').addEventListener('input', (e) => updateDB({ design: { ...userData.design, bgColor: e.target.value } }));
    document.getElementById('design-bg-img').addEventListener('input', (e) => updateDB({ design: { ...userData.design, bgImg: e.target.value } }));
    document.getElementById('design-font').addEventListener('change', (e) => updateDB({ design: { ...userData.design, font: e.target.value } }));

    // Link Modals
    window.openLinkModal = () => document.getElementById('link-modal').classList.add('visible');
    window.closeLinkModal = () => document.getElementById('link-modal').classList.remove('visible');
    window.saveLink = () => {
      const title = document.getElementById('new-title').value;
      const url = document.getElementById('new-url').value;
      if(!title || !url) return alert('Preencha tudo');
      updateDB({ links: [...userData.links, { title, url }] });
      closeLinkModal();
      document.getElementById('new-title').value = '';
      document.getElementById('new-url').value = '';
    };
    window.deleteLink = (i) => {
      if(!confirm("Remover?")) return;
      updateDB({ links: userData.links.filter((_, idx) => idx !== i) });
    };

    // Tabs
    window.switchTab = (tabId, btn) => {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      btn.classList.add('active');
    };

    window.copyUrl = () => { navigator.clipboard.writeText(document.getElementById('my-url').value); alert("Link copiado!"); };
    window.logout = () => signOut(auth).then(() => location.reload());
    document.getElementById('btn-google').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

    // --- INIT ---
    onAuthStateChanged(auth, async (user) => {
      const urlParams = new URLSearchParams(window.location.search);
      const publicUid = urlParams.get('u');

      // MODO PÚBLICO
      if(publicUid) {
        document.body.innerHTML = '';
        const snap = await getDoc(doc(db, "users", publicUid));
        if(snap.exists()) {
          const d = snap.data();
          const t = TEMPLATES.find(x => x.id === d.theme) || TEMPLATES[0];
          const tOut = t.render(d);
          // Replica a lógica de CSS Override no modo público
          let customCSS = '';
          const des = d.design || {};
          if (des.bgMode === 'color' && des.bgColor) customCSS += `body { background: ${des.bgColor} !important; background-image: none !important; } `;
          if (des.bgMode === 'image' && des.bgImg) customCSS += `body { background: url('${des.bgImg}') center/cover no-repeat fixed !important; } `;
          if (des.bgMode === 'gradient') customCSS += `body { background: linear-gradient(135deg, #6627ff, #ff0055) !important; background-image: none !important; } `;
          if (des.font && des.font !== 'inherit') customCSS += `body, h1, h2, h3, a, p { font-family: ${des.font} !important; } `;

          document.write(`<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><link href="https://fonts.googleapis.com/css2?family=Archivo:wght@900&family=Cinzel:wght@700&family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@500&family=Space+Grotesk:wght@700&family=VT323&family=Press+Start+2P&family=Playfair+Display:ital,wght@0,700;1,400&family=Outfit:wght@900&family=Permanent+Marker&family=UnifrakturMaguntia&family=Bangers&family=Poppins:wght@400;700&display=swap" rel="stylesheet"><title>${d.name}</title><style>${tOut.css} ${customCSS}</style></head><body>${tOut.html}</body></html>`);
        }
        return;
      }

      // MODO EDITOR
      if(user){
        currentUser = user;
        document.getElementById('auth-screen').classList.remove('visible');
        document.getElementById('my-url').value = `${window.location.origin}${window.location.pathname}?u=${user.uid}`;
        document.getElementById('open-btn').href = `?u=${user.uid}`;
        
        const snap = await getDoc(doc(db, "users", user.uid));
        if(snap.exists()) { 
          userData = snap.data();
          if(!userData.design) userData.design = { bgMode: 'default' }; // Migração
        } else { 
          await setDoc(doc(db, "users", user.uid), userData); 
        }
        renderUI();
      } else {
        document.getElementById('auth-screen').classList.add('visible');
      }
    });
  </script>
</body>
</html>
