<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asthro - Analisador de Performance Web</title>
    <style>
        /* Estilos CSS B√°sicos para a p√°gina */
        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px; /* Aumentado para melhor visualiza√ß√£o dos detalhes */
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #007bff;
            margin-bottom: 20px;
        }
        h2 {
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            margin-top: 30px;
            color: #333;
        }
        h3 {
            color: #007bff;
            margin-top: 20px;
        }
        #input-area {
            display: flex;
            margin-bottom: 20px;
        }
        #urlInput {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px 0 0 6px;
            font-size: 1em;
        }
        #analyzeButton {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 6px 6px 0;
            transition: background-color 0.3s;
            font-size: 1em;
        }
        #analyzeButton:hover {
            background-color: #0056b3;
        }
        #results {
            margin-top: 20px;
            padding-top: 20px;
        }
        .loading {
            text-align: center;
            font-size: 1.2em;
            color: #007bff;
            padding: 40px 0;
        }
        /* Grid de Pontua√ß√µes Principais e CWV */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .metric-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .metric-score {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 5px;
        }
        /* Cores de Pontua√ß√£o */
        .score-good { color: #28a745; }
        .score-medium { color: #ffc107; }
        .score-bad { color: #dc3545; }

        /* Estilos para o Acorde√£o (Collapsible UI) */
        .collapsible-header {
            cursor: pointer;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .collapsible-header:hover {
            opacity: 0.9;
        }
        .collapsible-header::after {
            content: '+';
            font-size: 1.5em;
            transition: transform 0.3s;
        }
        .collapsible-header.active::after {
            content: '-';
            transform: rotate(0deg); /* Exibe '-' quando ativo */
        }
        .collapsible-content {
            padding: 10px 15px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background-color: #fcfcfc;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        /* Status Cores no Header */
        .status-fail { background-color: #dc3545; color: white;} /* Vermelho */
        .status-warn { background-color: #ffc107; color: #333;} /* Amarelo */
        .status-pass { background-color: #28a745; color: white;} /* Verde */
        
        /* Estilos para o item de Auditoria */
        .audit-item {
            padding: 10px 0;
            border-bottom: 1px dashed #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        .audit-item:last-child {
            border-bottom: none;
        }
        .audit-item strong {
            font-size: 1em;
            margin-bottom: 5px;
        }
        .audit-item p {
            margin: 5px 0 0 0;
            font-size: 0.9em;
            color: #6c757d;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>üöÄ Asthro - Analisador de Performance Web Detalhado</h1>
    <p>Insira a URL do site (ex: https://www.asthro.com.br) para obter um diagn√≥stico completo e detalhado da performance e otimiza√ß√£o.</p>
    
    <div id="input-area">
        <input 
            type="url" 
            id="urlInput" 
            placeholder="Exemplo: https://seudominio.com.br" 
            required
        >
        <button id="analyzeButton" onclick="analyzeUrl()">Analisar Site</button>
    </div>

    <div id="results">
        <p style="text-align: center; color: #6c757d;">
            Aguardando URL para iniciar a an√°lise.
        </p>
    </div>
</div>

<script>
    // ** Sua Chave de API **
    const API_KEY = "AIzaSyCVI4jsvpC5L2UY2c99cVgwR-gc2VLV_XE"; 
    const API_ENDPOINT = "https://www.googleapis.com/pagespeedonline/v5/runPagespeed";
    const RESULTS_DIV = document.getElementById('results');
    const ANALYZE_BUTTON = document.getElementById('analyzeButton');

    function classifyScore(score) {
        if (score >= 90) return 'score-good';
        if (score >= 50) return 'score-medium';
        return 'score-bad';
    }

    // Fun√ß√£o para obter a classe de cor com base no valor da m√©trica (tempo)
    function classifyMetricValue(metricId, value) {
        // Classifica√ß√£o baseada nas regras do Lighthouse para Core Web Vitals (em ms)
        if (metricId === 'largest-contentful-paint' || metricId === 'first-contentful-paint' || metricId === 'total-blocking-time') {
            // Convers√£o de valores de tempo para n√∫meros para compara√ß√£o
            const match = value.match(/([\d\.]+)/);
            const ms = match ? parseFloat(match[1]) * (value.includes('s') ? 1000 : 1) : 0;
            
            if (ms <= 2500) return 'score-good'; // Bom
            if (ms <= 4000) return 'score-medium'; // Precisa de melhoria
            return 'score-bad'; // Ruim
        }
        // Para CLS, que √© um score decimal (ex: 0.05)
        if (metricId === 'cumulative-layout-shift') {
            const score = parseFloat(value);
            if (score <= 0.1) return 'score-good';
            if (score <= 0.25) return 'score-medium';
            return 'score-bad';
        }
        return '';
    }

    function analyzeUrl() {
        let url = document.getElementById('urlInput').value.trim();

        if (!url) {
            RESULTS_DIV.innerHTML = '<p class="score-bad">Por favor, insira uma URL v√°lida.</p>';
            return;
        }

        // Adiciona https:// se o usu√°rio esqueceu o protocolo
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            url = 'https://' + url;
            document.getElementById('urlInput').value = url; 
        }
        
        // Exibir carregamento
        RESULTS_DIV.innerHTML = '<div class="loading">Analisando... Por favor, aguarde cerca de 30 segundos.</div>';
        ANALYZE_BUTTON.disabled = true;

        // Construir o URL da API (Solicitando todas as categorias)
        const requestUrl = `${API_ENDPOINT}?url=${encodeURIComponent(url)}&key=${API_KEY}&strategy=desktop&category=PERFORMANCE&category=ACCESSIBILITY&category=BEST_PRACTICES&category=SEO`;

        fetch(requestUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                displayResults(data);
                setupCollapsibles(); // Chama a fun√ß√£o do acorde√£o ap√≥s renderizar
            })
            .catch(error => {
                RESULTS_DIV.innerHTML = `<p class="score-bad">‚ùå Erro na an√°lise: ${error.message}. Verifique a URL e a chave da API.</p>`;
                console.error("Erro ao buscar API:", error);
            })
            .finally(() => {
                ANALYZE_BUTTON.disabled = false;
            });
    }

    function displayResults(data) {
        if (!data || !data.lighthouseResult) {
            RESULTS_DIV.innerHTML = '<p class="score-bad">N√£o foi poss√≠vel obter dados para esta URL.</p>';
            return;
        }

        const lhr = data.lighthouseResult;
        const audits = lhr.audits;
        
        let htmlContent = `
            <h2>‚ú® Relat√≥rio Detalhado Asthro</h2>
            <p>An√°lise da URL: <strong>${lhr.finalUrl}</strong> (Vers√£o Desktop)</p>
            <p><small>Gerado em: ${new Date(lhr.fetchTime).toLocaleDateString()} √†s ${new Date(lhr.fetchTime).toLocaleTimeString()}</small></p>
            
            <h3>1. Pontua√ß√µes Gerais</h3>
            <div class="metric-grid">
                <!-- Pontua√ß√£o Principal (Performance) -->
                ${renderCategoryScore('performance', 'Performance', lhr.categories, classifyScore)}
                ${renderCategoryScore('accessibility', 'Acessibilidade', lhr.categories, classifyScore)}
                ${renderCategoryScore('best-practices', 'Melhores Pr√°ticas', lhr.categories, classifyScore)}
                ${renderCategoryScore('seo', 'SEO', lhr.categories, classifyScore)}
            </div>
            
            ${renderCoreWebVitals(audits)}
            
            <h3>3. Diagn√≥stico Detalhado por Categoria (Clique para Expandir)</h3>
            ${renderAuditDetails(lhr)}
            
            <div style="margin-top: 40px; padding: 20px; background-color: #e6f0ff; border-radius: 8px; text-align: center;">
                <h3>Pr√≥ximos Passos com a Asthro</h3>
                <p>Para resolver os pontos de melhoria e levar seu site √† pontua√ß√£o m√°xima, entre em contato. Somos especialistas em otimiza√ß√£o PageSpeed!</p>
                <strong style="color: #007bff;">Seu sucesso √© a nossa miss√£o!</strong>
            </div>
        `;
        
        RESULTS_DIV.innerHTML = htmlContent;
    }

    // --- Fun√ß√µes Auxiliares para Renderiza√ß√£o Detalhada ---

    function renderCategoryScore(key, label, categories, classifier) {
        const category = categories[key];
        if (!category) return '';
        
        const score = Math.round(category.score * 100);
        const cls = classifier(score);
        return `
            <div class="metric-box">
                <strong>${label}</strong>
                <div class="metric-score ${cls}">${score}%</div>
            </div>
        `;
    }

    function renderCoreWebVitals(audits) {
        const metrics = [
            { id: 'largest-contentful-paint', label: 'LCP (Maior Conte√∫do)' },
            { id: 'first-contentful-paint', label: 'FCP (Primeiro Conte√∫do)' },
            { id: 'total-blocking-time', label: 'TBT (Tempo de Bloqueio)' },
            { id: 'cumulative-layout-shift', label: 'CLS (Estabilidade Visual)' }
        ];

        let metricsHtml = metrics.map(m => {
            const audit = audits[m.id];
            if (!audit || !audit.displayValue) return '';

            const valueClass = classifyMetricValue(m.id, audit.displayValue);

            return `
                <div class="metric-box">
                    <strong>${m.label}</strong>
                    <div class="metric-score ${valueClass}" style="font-size: 1.4em;">${audit.displayValue}</div>
                </div>
            `;
        }).join('');

        return `
            <h3>2. Core Web Vitals (M√©tricas de Velocidade)</h3>
            <div class="metric-grid">${metricsHtml}</div>
        `;
    }

    function renderAuditDetails(lhr) {
        const categories = {
            'performance': 'Performance',
            'accessibility': 'Acessibilidade',
            'best-practices': 'Melhores Pr√°ticas',
            'seo': 'SEO (Otimiza√ß√£o de Buscas)'
        };

        let detailsHtml = '';

        for (const [key, categoryName] of Object.entries(categories)) {
            const auditRefs = lhr.categories[key].auditRefs;
            
            // 1. Falhas / Oportunidades (Score < 0.9)
            const failedAudits = auditRefs.filter(ref => lhr.audits[ref.id].score < 0.9 && lhr.audits[ref.id].score !== null);
            // 2. Aprovados (Score = 1)
            const passedAudits = auditRefs.filter(ref => lhr.audits[ref.id].score === 1);
            // 3. Informa√ß√µes ou Avisos (Score entre 0.9 e 1 ou sem score)
            const informationalAudits = auditRefs.filter(ref => 
                (lhr.audits[ref.id].score >= 0.9 && lhr.audits[ref.id].score < 1) || 
                (lhr.audits[ref.id].score === null && lhr.audits[ref.id].scoreDisplayMode === 'not applicable')
            );


            // --- Renderizar Falhas (Erros) - Se√ß√£o Collapsible ---
            if (failedAudits.length > 0) {
                detailsHtml += `
                    <div class="report-section">
                        <div class="collapsible-header status-fail">
                            ‚ùå ${categoryName}: Falhas e Oportunidades (${failedAudits.length})
                        </div>
                        <div class="collapsible-content">
                            ${failedAudits.map(ref => renderAuditItem(lhr.audits[ref.id])).join('')}
                        </div>
                    </div>
                `;
            }

            // --- Renderizar Avisos / Informa√ß√µes (Aten√ß√£o) - Se√ß√£o Collapsible ---
             if (informationalAudits.length > 0) {
                detailsHtml += `
                    <div class="report-section">
                        <div class="collapsible-header status-warn">
                            ‚ö†Ô∏è ${categoryName}: Diagn√≥sticos e Avisos (${informationalAudits.length})
                        </div>
                        <div class="collapsible-content">
                            ${informationalAudits.map(ref => renderAuditItem(lhr.audits[ref.id])).join('')}
                        </div>
                    </div>
                `;
            }

            // --- Renderizar Aprovados (Acertos) - Se√ß√£o Collapsible ---
            if (passedAudits.length > 0) {
                detailsHtml += `
                    <div class="report-section">
                        <div class="collapsible-header status-pass">
                            ‚úÖ ${categoryName}: Testes Aprovados (${passedAudits.length})
                        </div>
                        <div class="collapsible-content">
                            ${passedAudits.map(ref => renderAuditItem(lhr.audits[ref.id])).join('')}
                        </div>
                    </div>
                `;
            }
        }
        return detailsHtml;
    }

    function renderAuditItem(audit) {
        // Remove links Markdown da descri√ß√£o para simplificar a visualiza√ß√£o (e mant√©m em portugu√™s)
        const descriptionClean = audit.description ? audit.description.replace(/\[.*\]\(.*\)/g, '').trim() : 'Nenhuma descri√ß√£o dispon√≠vel.';

        // Adiciona informa√ß√µes de economia de tempo se dispon√≠veis (para Performance)
        let savingsInfo = '';
        if (audit.details && audit.details.overallSavingsMs > 0) {
            // Convers√£o de milissegundos para segundos
            const savingsSeconds = (audit.details.overallSavingsMs / 1000).toFixed(2);
            savingsInfo = ` (Economia Estimada: ${savingsSeconds}s)`;
        }
        
        return `
            <div class="audit-item">
                <strong>${audit.title} ${savingsInfo}</strong>
                <p>${descriptionClean}</p>
            </div>
        `;
    }

    // --- Nova Fun√ß√£o para L√≥gica de Acorde√£o ---
    function setupCollapsibles() {
        const headers = document.querySelectorAll('.collapsible-header');

        headers.forEach(header => {
            header.addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    // Define a altura m√°xima para o scrollHeight (altura necess√°ria para exibir todo o conte√∫do)
                    content.style.maxHeight = content.scrollHeight + "px";
                } 
            });
        });
    }

    // Inicializa a l√≥gica de carregamento inicial (se a p√°gina for atualizada)
    document.addEventListener('DOMContentLoaded', () => {
        // Nada a fazer no DOMContentLoaded, a fun√ß√£o setupCollapsibles √© chamada em displayResults
    });
</script>

</body>
</html>
